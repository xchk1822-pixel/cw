<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #3f51b5; --bg: #f5f7fa; --success: #43a047; --danger: #e53935; --warning: #ffa000; --info: #00acc1; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .box { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .header { background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 20px; }
        #clock { position: absolute; right: 20px; font-size: 14px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 15px; }
        .card { padding: 15px; border-radius: 6px; color: white; text-align: center; }
        .bg-rev { background: var(--success); } .bg-total { background: #546e7a; } .bg-exp { background: var(--danger); } .bg-profit { background: #fb8c00; } .bg-debt { background: #1e88e5; }
        .val-big { font-size: 20px; font-weight: bold; margin: 5px 0; }
        .val-small { font-size: 11px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 8px 10px; text-align: left; font-size: 13px; word-break: break-all; }
        th { background: #f8f9fa; color: #666; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .cal-day { border: 1px solid #eee; padding: 5px 2px; text-align: center; border-radius: 4px; font-size: 11px; background: #fff; min-height: 40px;}
        .cal-day.has-data { background: #e8f5e9; border-color: #c8e6c9; }
        .tag-box { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .tag { background: #eceff1; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 5px; justify-content: space-between;}
        .tag b { color: #e53935; cursor: pointer; font-size: 16px; }
        .move-btn { cursor: pointer; color: var(--primary); font-weight: bold; padding: 0 3px; font-size: 14px; }
        .batch-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .search-bar { background: #e8eaf6; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        #img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        #img-modal img { max-width:90%; max-height:90%; border:3px solid white; }
        .sub-row { background: #fafafa; font-size: 12px; color: #777; }
        .capture-area { border: 2px dashed #ccc; padding: 10px; margin: 10px 0; display: none; text-align: center; }
        video { width: 100%; border-radius: 4px; background: #000; }

        .txt-rev-line { color: #1a237e; font-weight: bold; border-bottom: 1px solid #f0f0f0; padding-bottom: 2px; margin-bottom: 2px; display: block; }
        .txt-exp-line { color: #d32f2f; font-size: 12px; display: block; }

        @media print {
            .no-print, aside, .header, .grid-5, .search-bar, .tag-box, button { display: none !important; }
            body { background: white; padding: 0; margin: 0; font-size: 10px; }
            .main-layout { display: block; }
            .box { box-shadow: none; border: 1px solid #000; margin-bottom: 10px; padding: 5px; border-radius: 0; }
            table { font-size: 10px; margin-top: 5px; }
            th, td { padding: 3px 5px; border: 1px solid #333; color: #000 !important; }
            .card, .bg-rev, .bg-total, .bg-exp, .bg-profit, .bg-debt { color: #000; background: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body onload="init()">
    <div class="header no-print">
        <h2 style="margin:0; letter-spacing:2px;">BLUEFIELD é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</h2>
        <div id="clock"></div>
    </div>

    <div class="grid-5 no-print">
        <div class="card bg-total">
            <div>ç´¯è®¡é”€å”®(å…¨)</div>
            <div class="val-big" id="h-all-rev">0</div>
            <div class="val-small">è‡ªç³»ç»Ÿå¯ç”¨ä»¥æ¥</div>
        </div>
        <div class="card bg-rev">
            <div>æœ¬æœŸå®æ”¶</div>
            <div class="val-big" id="h-mon-rev">0</div>
            <div class="val-small" id="h-pos-info">ç°é‡‘ + POS</div>
        </div>
        <div class="card bg-exp">
            <div>æœ¬æœŸæ”¯å‡º</div>
            <div class="val-big" id="h-mon-exp">0</div>
            <div class="val-small">åŒ…å«è¿˜æ¬¾ä¸æ—¥å¸¸</div>
        </div>
        <div class="card bg-profit">
            <div>æœ¬æœŸç›ˆäº</div>
            <div class="val-big" id="h-profit">0</div>
            <div class="val-small">è¥æ”¶ - æ”¯å‡º + è¯¯å·®</div>
        </div>
        <div class="card bg-debt">
            <div>ä¾›åº”å•†æ¬ æ¬¾æ€»é¢</div>
            <div class="val-big" id="h-debt">0</div>
            <div class="val-small">æŒ‚è´¦ - å·²è¿˜</div>
        </div>
    </div><div class="main-layout">
        <aside class="no-print">
            <div class="box">
                <h3 style="margin-top:0">ğŸ“… ç­æ¬¡ç»“è´¦ (Day-Sum)</h3>
                <form id="shiftForm">
                    <input type="date" id="in-date" required>
                    <input type="number" id="in-total-sales" step="0.1" placeholder="å°ç¥¨æµæ°´æ€»é¢ (Zç›˜)" required oninput="calcShift()">
                    <input type="number" id="in-pos-sales" step="0.1" placeholder="åˆ·å¡æ€»é¢ (POS)" required oninput="calcShift()">
                    <input type="number" id="in-diff" step="0.1" placeholder="è¯¯å·®å€¼ (å¯ä¸å¡«)" oninput="calcShift()">
                    <div style="margin:10px 0; border-top:1px solid #eee; padding-top:10px;">
                        <label style="font-size:12px; color:#666;">æ”¯å‡ºæ˜ç»†ï¼š</label>
                        <div id="exp-rows"></div>
                        <button type="button" onclick="addExpRow()" style="background:#f0f0f0; color:#333; margin-top:5px;">+ æ·»åŠ æ”¯å‡ºé¡¹</button>
                    </div>
                    <div id="shift-preview" style="font-size:12px; color:#e65100; background:#fff3e0; padding:8px; border-radius:4px; margin-bottom:10px;"></div>
                    <input type="file" id="in-file-shift" accept="image/*" capture="environment">
                    <button type="submit" style="background:var(--success)">ä¿å­˜ç­æ¬¡æ•°æ®</button>
                </form>
            </div>

            <div class="box">
                <h3 style="margin-top:0">ğŸ·ï¸ æŒ‚è´¦ / è¿˜æ¬¾ (Debt)</h3>
                <form id="debtForm">
                    <select id="in-action" onchange="toggleDebtHelper()" required>
                        <option value="buy">é‡‡è´­æŒ‚è´¦ (+)</option>
                        <option value="pay">è¿˜æ¬¾æ”¯ä»˜ (-)</option>
                    </select>
                    <input type="date" id="debt-date" required>
                    <select id="sel-sup" required></select>
                    <input type="text" id="in-bill" placeholder="å•æ®å· (é€‰å¡«)">
                    
                    <div id="debt-helper" style="display:none; background:#f0f4f8; padding:8px; border-radius:4px; margin-bottom:10px;">
                        <label style="font-size:12px; color:#333;">å¿«é€Ÿå¡«æŠ¥ï¼š</label>
                        <div id="debt-tag-rows"></div>
                        <button type="button" onclick="addDebtTagRow()" style="background:#fff; color:#333; font-size:12px;">+ é€‰åˆ†ç±»</button>
                    </div>
                    
                    <input type="number" id="debt-amt" step="0.1" placeholder="æ€»é‡‘é¢" required>
                    <input type="file" id="in-file-debt" accept="image/*" capture="environment">
                    <button type="submit" style="background:var(--info)">ç¡®è®¤ç™»è®°</button>
                </form>
            </div>

            <div class="box">
                <h3 style="margin-top:0">ğŸ‘¤ å‘˜å·¥æ”¯å–/å·¥èµ„</h3>
                <form id="staffForm">
                    <select id="staff-type" required>
                        <option value="loan">å€Ÿæ”¯ / é¢„æ”¯ (-)</option>
                        <option value="salary">å‘æ”¾å·¥èµ„ (+)</option>
                    </select>
                    <input type="date" id="staff-date" required>
                    <select id="sel-staff" required></select>
                    <input type="number" id="staff-amt" step="0.1" placeholder="é‡‘é¢" required>
                    <input type="text" id="staff-notes" placeholder="å¤‡æ³¨ (å¦‚ï¼š10æœˆä¸ŠåŠæœˆ)">
                    <input type="file" id="in-file-staff" accept="image/*" capture="environment">
                    <button type="submit" style="background:#7e57c2">ç™»è®°ä¿¡æ¯</button>
                </form>
            </div>

            <div class="box">
                <h3>âš™ï¸ åŸºç¡€è®¾ç½®</h3>
                <div class="tag-box">
                    <label>ä¾›åº”å•†åˆ—è¡¨ï¼š<small onclick="addSetting('sup')" style="cursor:pointer;color:blue">[æ–°å¢]</small></label>
                    <div id="list-sup"></div>
                </div>
                <div class="tag-box">
                    <label>å‘˜å·¥åˆ—è¡¨ï¼š<small onclick="addSetting('staff')" style="cursor:pointer;color:blue">[æ–°å¢]</small></label>
                    <div id="list-staff"></div>
                </div>
                <div class="tag-box">
                    <label>æ”¯å‡ºåˆ†ç±»ï¼š<small onclick="addParentCat()" style="cursor:pointer;color:blue">[æ–°å¢å¤§ç±»]</small></label>
                    <div id="list-cat" style="background:#fcfcfc; padding:5px; border-radius:4px;"></div>
                </div>
                <hr>
                <button onclick="exportBackup()" style="background:#546e7a">å¯¼å‡ºå¤‡ä»½ (JSON)</button>
                <button onclick="importBackup()" style="background:#90a4ae; margin-top:5px;">å¯¼å…¥å¤‡ä»½</button>
            </div>
        </aside>

        <main>
            <div class="search-bar no-print">
                <div style="flex:1">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="f-start" onchange="render()">
                </div>
                <div style="flex:1">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="f-end" onchange="render()">
                </div>
                <div style="flex:1">
                    <label>å…³é”®å­—æœç´¢</label>
                    <input type="text" id="f-key" placeholder="ä¾›åº”å•†/å•å·/å¤‡æ³¨..." oninput="render()">
                </div>
                <div style="flex:0.5">
                    <button onclick="exportExcel()" style="background:#2e7d32">å¯¼å‡º Excel</button>
                </div>
                <div style="flex:0.5">
                    <button onclick="window.print()" style="background:#444">æ‰“å°æŠ¥è¡¨</button>
                </div>
            </div>

            <div class="grid-5" style="grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr 1fr; gap:10px;">
                <div class="box">
                    <h4 style="margin:0 0 10px 0">ğŸ“… æ—¥å†è§†å›¾ (æŒ‰æœˆ)</h4>
                    <input type="month" id="cal-picker" onchange="render()" style="margin-bottom:5px;">
                    <div class="calendar-grid" id="calendar"></div>
                </div>
                <div class="box">
                    <h4 style="margin:0 0 10px 0">ğŸ“Š è¥æ”¶æ¦‚å†µ</h4>
                    <table id="revTable"><thead><tr><th>é¡¹ç›®</th><th>é‡‘é¢</th></tr></thead><tbody id="revTbody"></tbody></table>
                </div>
                <div class="box">
                    <h4 style="margin:0 0 10px 0">ğŸ“‰ æ”¯å‡ºåˆ†ç±»æ’è¡Œ</h4>
                    <table id="expTable"><thead><tr><th>åˆ†ç±»</th><th>é‡‘é¢</th><th>%</th></tr></thead><tbody id="expTbody"></tbody></table>
                </div>
                <div class="box">
                    <h4 style="margin:0 0 10px 0">ğŸ¥© é‡‡è´­å•å“ç»Ÿè®¡</h4>
                    <table id="itemTable"><thead><tr><th>é¡¹</th><th>é‡‘é¢</th></tr></thead><tbody id="itemTbody"></tbody></table>
                </div>
                <div class="box">
                    <h4 style="margin:0 0 10px 0">ğŸ‘¤ å‘˜å·¥å¹³è¡¡</h4>
                    <table id="staffTable"><thead><tr><th>å§“å</th><th>æ”¯/å·¥</th></tr></thead><tbody id="staffTbody"></tbody></table>
                </div>
            </div>

            <div class="box" style="margin-bottom:10px">
                <h3 style="margin:0 0 10px 0; display:flex; justify-content:space-between">
                    <span>ğŸ“‘ è´¢åŠ¡æµæ°´æ˜ç»†</span>
                    <span style="font-size:12px">
                        <input type="radio" name="m" checked onclick="mode='shift';render()"> è¥æ”¶ 
                        <input type="radio" name="m" onclick="mode='debt';render()"> æŒ‚è´¦ 
                        <input type="radio" name="m" onclick="mode='staff';render()"> å‘˜å·¥
                    </span>
                </h3>
                <div style="max-height:600px; overflow-y:auto">
                    <table>
                        <thead style="position:sticky; top:0; background:#eee; z-index:10">
                            <tr><th width="100">æ—¥æœŸ</th><th width="60">ç±»å‹</th><th>è¯¦æƒ…å†…å®¹</th><th width="80">é‡‘é¢</th><th width="40" class="no-print">å›¾</th><th width="40" class="no-print">æ“</th></tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="box">
                <h3 style="margin:0 0 10px 0">ğŸš© å¾…æ”¯ä»˜æŒ‚è´¦æ±‡æ€» (æŒ‰å•å·)</h3>
                <table id="billTable"><thead><tr><th>ä¾›åº”å•†</th><th>å•å·</th><th>é‡‡è´­é¢</th><th>å·²ä»˜</th><th>ä½™é¢</th></tr></thead><tbody id="billTbody"></tbody></table>
            </div>
        </main>
    </div>

    <div id="img-modal" onclick="this.style.display='none'"><img id="modal-content"></div>

<script>
    let db = { recs: [], sups: [], staffs: [], cats: {}, catOrder: [] };
    const CUR = "C$";
    let mode = 'shift';
    const BIN_ID = '67b36f78e41b4d34e495f269';
    const API_KEY = '$2a$10$fI8AAnP/N7vWf94mXf6Ose7pC8hR.G/wM8m8m8m8m8m8m8m8m8m8m'; // æ³¨æ„ï¼šæ­¤å¤„åº”ä½¿ç”¨æ‚¨å®é™…çš„API Key

    async function init() {
        const local = localStorage.getItem('bluefield_db');
        if(local) db = JSON.parse(local);
        
        // è¡¥å…¨åŸºç¡€ç»“æ„é˜²æ­¢è€æ•°æ®æŠ¥é”™
        if(!db.catOrder) db.catOrder = [];
        if(!db.cats) db.cats = {};

        resetInputsToToday();
        await syncCloud('get');
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
        addExpRow();
        render();
    }

    function resetInputsToToday() {
        const today = new Date().toISOString().split('T')[0];
        const month = today.substring(0, 7);
        ['in-date','debt-date','staff-date','f-start','f-end'].forEach(id => document.getElementById(id).value = today);
        document.getElementById('cal-picker').value = month;
    }

    async function syncCloud(type) {
        try {
            if(type === 'get') {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                if(res.ok) { const data = await res.json(); if(data.record.recs) { db = data.record; localStorage.setItem('bluefield_db', JSON.stringify(db)); } }
            } else {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(db)
                });
            }
        } catch(e) { console.error("Cloud Sync Error", e); }
    }

    function forceSave(rec) {
        db.recs.push(rec);
        localStorage.setItem('bluefield_db', JSON.stringify(db));
        render();
        syncCloud('put');
    }function render() {
        const fS = document.getElementById('f-start').value, fE = document.getElementById('f-end').value, fK = document.getElementById('f-key').value.toLowerCase();
        
        // æ¸²æŸ“è®¾ç½®é¢æ¿ä¸­çš„åŸºç¡€åˆ—è¡¨
        document.getElementById('list-sup').innerHTML = db.sups.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('sup',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-sup').innerHTML = db.sups.map(s=>`<option>${s}</option>`).join('');
        document.getElementById('list-staff').innerHTML = db.staffs.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('staff',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-staff').innerHTML = db.staffs.map(s=>`<option>${s}</option>`).join('');
        
        // æ¸²æŸ“åˆ†ç±»ç®¡ç†é€»è¾‘ï¼ˆå¸¦æ›´åä¸æ’åºï¼‰
        let catH = "";
        db.catOrder.forEach((p, pi) => {
            catH += `<div style="font-weight:bold; font-size:12px; margin-top:8px; color:#3f51b5; display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <span contenteditable="true" 
                                  onblur="renameParentCat('${p}', this.innerText)" 
                                  onkeydown="if(event.keyCode==13){event.preventDefault();this.blur();}"
                                  style="border-bottom:1px dashed #3f51b5; cursor:text; padding:0 3px;">${p}</span>
                            <small onclick="addChildCat('${p}')" style="cursor:pointer; color:green; margin-left:5px;">[+]</small>
                        </span>
                        <span>
                            <span class="move-btn" onclick="moveParent(${pi},-1)">â†‘</span>
                            <span class="move-btn" onclick="moveParent(${pi},1)">â†“</span>
                            <small onclick="delParentCat('${p}')" style="cursor:pointer; color:red; margin-left:5px;">[Ã—]</small>
                        </span>
                    </div>`;
            
            if(db.cats[p]) db.cats[p].forEach((c, ci) => { 
                catH += `<div class="tag" style="margin-left:10px;">
                            <span contenteditable="true" 
                                  onblur="renameChildCat('${p}', '${c}', this.innerText)"
                                  onkeydown="if(event.keyCode==13){event.preventDefault();this.blur();}"
                                  style="cursor:text; min-width:30px; display:inline-block;">${c}</span>
                            <span>
                                <span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},-1)">â†‘</span>
                                <span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},1)">â†“</span>
                                <b onclick="delChildCat('${p}',${ci})">Ã—</b>
                            </span>
                        </div>`; 
            });
        });
        document.getElementById('list-cat').innerHTML = catH;

        // åˆå§‹åŒ–ç»Ÿè®¡å˜é‡
        let stats = { mCash:0, mPos:0, mExp:0, mSales:0, aSales:0, tDebt:0, mDiff:0 };
        let calData = {}, expAgg = {}, itemAgg = {}, staffSummary = {}, billAgg = {};
        db.staffs.forEach(s => staffSummary[s] = {sal:0, loan:0});

        // æ ¸å¿ƒå¾ªç¯é€»è¾‘ï¼šè®¡ç®—ç´¯è®¡æ•°æ®ä¸è¿‡æ»¤æ•°æ®
        db.recs.forEach(r => {
            // å…¨å±€ç´¯è®¡æ•°æ®
            if(r.type === 'buy') stats.tDebt += (r.amt||0);
            if(r.type === 'pay') stats.tDebt -= (r.amt||0);
            if(r.type === 'day-sum') stats.aSales += (r.totalSales||0);

            // è¿‡æ»¤èŒƒå›´å†…æ•°æ®
            const inDate = (r.date >= fS && r.date <= fE);
            if(inDate) {
                const isDebtModule = (r.type === 'buy' || r.type === 'pay');
                const isMatch = !fK || (isDebtModule ? (r.sup && r.sup.toLowerCase().includes(fK)) : JSON.stringify(r).toLowerCase().includes(fK));
                
                if(isDebtModule && isMatch) {
                    const bKey = `${r.sup}_${r.bill || 'æ— å•å·'}`;
                    if(!billAgg[bKey]) billAgg[bKey] = { sup: r.sup, bill: r.bill || 'æ— å•å·', buy: 0, pay: 0 };
                    if(r.type === 'buy') billAgg[bKey].buy += (r.amt||0);
                    if(r.type === 'pay') billAgg[bKey].pay += (r.amt||0);
                }
                
                if(r.type === 'salary' && staffSummary[r.staff]) staffSummary[r.staff].sal += (r.amt||0); 
                else if(r.type === 'loan' && staffSummary[r.staff]) staffSummary[r.staff].loan += (r.amt||0);
                
                if(r.type === 'day-sum') {
                    stats.mCash += (r.cash||0); 
                    stats.mPos += (r.pos||0); 
                    stats.mSales += (r.totalSales||0); 
                    stats.mDiff += (r.diff||0);
                    if(r.expDetails) r.expDetails.forEach(ed => { 
                        stats.mExp += ed.amt; 
                        expAgg[ed.cat] = (expAgg[ed.cat]||0)+ed.amt; 
                        let iname = ed.cat.split(':')[1]; 
                        itemAgg[iname] = (itemAgg[iname]||0)+ed.amt; 
                    });
                } else if(r.type === 'pay') { 
                    stats.mExp += (r.amt||0); 
                    expAgg['è¿˜æ¬¾:ä¾›åº”å•†'] = (expAgg['è¿˜æ¬¾:ä¾›åº”å•†']||0)+(r.amt||0); 
                }
            }
            // æ—¥å†æ•°æ®åŒ¹é…
            if(inDate && r.type==='day-sum' && r.date.startsWith(document.getElementById('cal-picker').value)) {
                calData[r.date] = (calData[r.date]||0)+(r.totalSales||0);
            }
        });

        // æ¸²æŸ“é¡¶éƒ¨å¡ç‰‡
        const currentProfit = stats.mSales - stats.mExp + stats.mDiff;
        document.getElementById('h-all-rev').innerText = CUR + stats.aSales.toFixed(0);
        document.getElementById('h-mon-rev').innerText = CUR + (stats.mCash + stats.mPos).toFixed(1);
        document.getElementById('h-pos-info').innerHTML = `<span style="color:#ffeb3b">ç° ${CUR}${stats.mCash.toFixed(1)}</span> | <span style="color:#ffeb3b">PO ${CUR}${stats.mPos.toFixed(1)}</span>`;
        document.getElementById('h-mon-exp').innerText = CUR + stats.mExp.toFixed(1);
        document.getElementById('h-profit').innerText = CUR + currentProfit.toFixed(1);
        document.getElementById('h-debt').innerText = CUR + stats.tDebt.toFixed(1);

        // æ¸²æŸ“è¡¨æ ¼
        document.getElementById('revTbody').innerHTML = `<tr><td>å°ç¥¨æ€»é¢</td><td>${CUR}${stats.mSales.toFixed(1)}</td></tr><tr><td>ç°é‡‘å®æ”¶</td><td>${CUR}${stats.mCash.toFixed(1)}</td></tr><tr><td>åˆ·å¡(POS)</td><td>${CUR}${stats.mPos.toFixed(1)}</td></tr><tr style="color:orange"><td>è¯¯å·®å€¼</td><td>${CUR}${stats.mDiff.toFixed(1)}</td></tr><tr style="font-weight:bold; border-top:2px solid #eee;"><td>ç›ˆäº</td><td style="color:${currentProfit>=0?'green':'red'}">${CUR}${currentProfit.toFixed(1)}</td></tr>`;
        document.getElementById('itemTbody').innerHTML = Object.entries(itemAgg).sort((a, b) => b[1] - a[1]).map(([k,v])=>`<tr><td>${k}</td><td>${CUR}${v.toFixed(1)}</td></tr>`).join('');
        document.getElementById('billTbody').innerHTML = Object.values(billAgg).map(b => `<tr><td>${b.sup}</td><td>${b.bill}</td><td>${CUR}${b.buy.toFixed(1)}</td><td>${CUR}${b.pay.toFixed(1)}</td><td style="color:${(b.buy-b.pay)>0?'red':'green'}">${CUR}${(b.buy-b.pay).toFixed(1)}</td></tr>`).join('');

        // æ¸²æŸ“æ’åºåçš„åˆ†ç±»ç»Ÿè®¡
        let sortedCats = db.catOrder.map(p => {
            let pA = 0;
            Object.entries(expAgg).forEach(([k, v]) => { if (k.startsWith(p + ':')) pA += v; });
            return { name: p, total: pA };
        }).filter(item => item.total > 0).sort((a, b) => b.total - a.total);

        let eH = ""; 
        sortedCats.forEach(cat => {
            const p = cat.name; const pA = cat.total;
            eH += `<tr style="background:#f9f9f9;font-weight:bold"><td>${p}</td><td>${CUR}${pA.toFixed(1)}</td><td>${(pA/(stats.mExp||1)*100).toFixed(1)}%</td></tr>`; 
            let subList = [];
            Object.entries(expAgg).forEach(([k, v]) => { if (k.startsWith(p + ':')) subList.push({ name: k.split(':')[1], val: v }); });
            subList.sort((a, b) => b.val - a.val);
            subList.forEach(item => { eH += `<tr class="sub-row"><td>â”” ${item.name}</td><td>${CUR}${item.val.toFixed(1)}</td><td></td></tr>`; });
        });
        document.getElementById('expTbody').innerHTML = eH; 

        // å‘˜å·¥ç»Ÿè®¡æ¸²æŸ“
        let staffRows = "", totalSal = 0, totalLoan = 0;
        Object.entries(staffSummary).forEach(([name, val]) => {
            totalSal += val.sal; totalLoan += val.loan;
            staffRows += `<tr><td>${name}</td><td>${CUR}${val.sal.toFixed(1)}</td><td>${CUR}${val.loan.toFixed(1)}</td><td>${CUR}${(val.sal-val.loan).toFixed(1)}</td></tr>`;
        });
        staffRows = `<tr style="background:#fff9c4; font-weight:bold;"><td>ğŸŒŸ å…¨å‘˜åˆè®¡</td><td>${CUR}${totalSal.toFixed(1)}</td><td>${CUR}${totalLoan.toFixed(1)}</td><td>${CUR}${(totalSal-totalLoan).toFixed(1)}</td></tr>` + staffRows;
        document.getElementById('staffTbody').innerHTML = staffRows;

        // æµæ°´è¡¨æ ¼æ˜ç»†
        const filtered = db.recs.filter(r => {
            const inDate = (r.date >= fS && r.date <= fE);
            const isDebtModule = (r.type === 'buy' || r.type === 'pay');
            const inKey = !fK || (isDebtModule ? (r.sup && r.sup.toLowerCase().includes(fK)) : JSON.stringify(r).toLowerCase().includes(fK));
            let inMode = (mode === 'shift' && r.type === 'day-sum') || (mode === 'debt' && isDebtModule) || (mode === 'staff' && (r.type === 'salary' || r.type === 'loan'));
            return inDate && inKey && inMode;
        });

        document.getElementById('tbody').innerHTML = filtered.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).map(r => {
            let typeLabel = {'day-sum':'æ”¶æ”¯','buy':'æŒ‚è´¦','pay':'è¿˜æ¬¾','salary':'å·¥èµ„','loan':'å€Ÿæ¬¾'}[r.type];
            let detailHtml = "";
            if (r.type === 'day-sum') {
                detailHtml = `<span class="txt-rev-line">æ”¶: ${CUR}${r.totalSales.toFixed(1)} (P:${r.pos.toFixed(1)}) ${r.diff?`è¯¯:${r.diff}`:''}</span>`;
                if(r.expDetails) detailHtml += `<span class="txt-exp-line">æ”¯: ${r.expDetails.map(ed=>ed.cat.split(':')[1]+CUR+ed.amt).join(', ')}</span>`;
            } else if (r.type === 'buy') {
                detailHtml = `[${r.sup}] ${r.itemDetails ? r.itemDetails.map(i=>i.name.split(':')[1]+CUR+i.amt).join(',') : 'é‡‡è´­'}`;
            } else if (r.type === 'pay') {
                detailHtml = `è¿˜æ¬¾è‡³ [${r.sup}]`;
            } else {
                detailHtml = `<b>${r.staff}</b>: ${r.notes||''}`;
            }
            return `<tr><td>${r.date}</td><td>${typeLabel}</td><td>${detailHtml}</td><td>${CUR}${(r.type==='day-sum'?(r.cash+r.pos):(r.amt||0)).toFixed(1)}</td><td class="no-print">${r.img?`<button onclick="showImg('${r.img}')">å›¾</button>`:'-'}</td><td class="no-print"><button onclick="delRec(${r.id})" style="background:#ffcdd2;color:red">åˆ </button></td></tr>`;
        }).join('');
        
        renderCalendar(document.getElementById('cal-picker').value, calData);
    }

    // åˆ†ç±»ç®¡ç†æ ¸å¿ƒï¼šæ›´åä¸å±‚çº§é€»è¾‘ (ç»ä¸ç²¾ç®€)
    function renameParentCat(oldName, newName) {
        newName = newName.trim();
        if (!newName || oldName === newName) { render(); return; }
        if (db.catOrder.includes(newName)) { alert("åç§°å·²å­˜åœ¨"); render(); return; }
        db.cats[newName] = db.cats[oldName];
        delete db.cats[oldName];
        const idx = db.catOrder.indexOf(oldName);
        if (idx !== -1) db.catOrder[idx] = newName;
        db.recs.forEach(r => {
            if (r.expDetails) r.expDetails.forEach(ed => { if (ed.cat.startsWith(oldName + ':')) ed.cat = ed.cat.replace(oldName + ':', newName + ':'); });
        });
        render(); syncCloud('put');
    }

    function renameChildCat(p, oldC, newC) {
        newC = newC.trim(); if(!newC || oldC === newC) { render(); return; }
        const idx = db.cats[p].indexOf(oldC); if(idx!==-1) db.cats[p][idx] = newC;
        db.recs.forEach(r => {
            if(r.expDetails) r.expDetails.forEach(ed => { if(ed.cat === p + ':' + oldC) ed.cat = p + ':' + newC; });
        });
        render(); syncCloud('put');
    }

    function addChildCat(p) { const v = prompt(`åœ¨ ${p} ä¸‹æ–°å¢:`); if(v && !db.cats[p].includes(v)) { db.cats[p].push(v); render(); } }
    function addParentCat() { const v = prompt("å¤§ç±»åç§°:"); if(v && !db.catOrder.includes(v)) { db.catOrder.push(v); db.cats[v] = []; render(); } }
    function delParentCat(p) { if(confirm(`åˆ é™¤ ${p}ï¼Ÿ`)) { delete db.cats[p]; db.catOrder = db.catOrder.filter(x=>x!==p); render(); } }
    function delChildCat(p, i) { db.cats[p].splice(i,1); render(); }
    function moveParent(i, dir) { const t = i + dir; if(t>=0 && t<db.catOrder.length) { [db.catOrder[i], db.catOrder[t]] = [db.catOrder[t], db.catOrder[i]]; render(); } }
    function moveChild(p, i, dir) { const t = i + dir; if(t>=0 && t<db.cats[p].length) { [db.cats[p][i], db.cats[p][t]] = [db.cats[p][t], db.cats[p][i]]; render(); } }

    // å…¶ä»–è¾…åŠ©é€»è¾‘
    function renderCalendar(monStr, data) {
        const cal = document.getElementById('calendar'); cal.innerHTML = "";
        const [y, m] = monStr.split('-').map(Number);
        const days = new Date(y, m, 0).getDate();
        const start = new Date(y, m-1, 1).getDay();
        for(let i=0; i<start; i++) cal.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const v = data[ds] || 0;
            cal.innerHTML += `<div class="cal-day ${v?'has-data':''}" onclick="document.getElementById('f-start').value='${ds}';document.getElementById('f-end').value='${ds}';render();"><b>${d}</b><br>${v?CUR+v.toFixed(0):''}</div>`;
        }
    }

    async function getImg(input) {
        const file = input.files[0]; if(!file) return null;
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 800;
                    if(w > max) { h *= max/w; w = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    res(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function addExpRow() {
        const div = document.createElement('div'); div.className = 'batch-row';
        let opts = ""; db.catOrder.forEach(p => db.cats[p].forEach(c => opts += `<option value="${p}:${c}">${p}-${c}</option>`));
        div.innerHTML = `<select class="e-cat">${opts}</select><input type="number" class="e-amt" placeholder="é‡‘é¢" oninput="calcShift()"><b onclick="this.parentElement.remove();calcShift()">Ã—</b>`;
        document.getElementById('exp-rows').appendChild(div);
    }

    function addDebtTagRow() {
        const div = document.createElement('div'); div.className = 'batch-row';
        let opts = ""; db.catOrder.forEach(p => db.cats[p].forEach(c => opts += `<option value="${p}:${c}">${p}-${c}</option>`));
        div.innerHTML = `<select class="d-cat">${opts}</select><input type="number" class="d-amt" placeholder="é‡‘é¢" oninput="calcDebtTotal()"><b onclick="this.parentElement.remove();calcDebtTotal()">Ã—</b>`;
        document.getElementById('debt-tag-rows').appendChild(div);
    }
    
    function calcDebtTotal() { let t=0; document.querySelectorAll('.d-amt').forEach(i=>t+=parseFloat(i.value)||0); if(t>0) document.getElementById('debt-amt').value=t.toFixed(1); }
    function calcShift() {
        const ts = parseFloat(document.getElementById('in-total-sales').value)||0, ps = parseFloat(document.getElementById('in-pos-sales').value)||0, df = parseFloat(document.getElementById('in-diff').value)||0;
        let ea = 0; document.querySelectorAll('.e-amt').forEach(i => ea += (parseFloat(i.value)||0));
        document.getElementById('shift-preview').innerText = `ç°æ”¶: ${CUR}${(ts-ps).toFixed(1)} | æ”¯å‡º: ${CUR}${ea.toFixed(1)} | ç»“å­˜: ${CUR}${(ts-ps-ea+df).toFixed(1)}`;
    }

    function delRec(id) { if(confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) { db.recs = db.recs.filter(r=>r.id!==id); render(); syncCloud('put'); } }
    function delSet(key, i) { const k = key==='sup'?'sups':'staffs'; db[k].splice(i,1); render(); syncCloud('put'); }
    function addSetting(key) { const v = prompt("è¾“å…¥åç§°:"); if(v) { const k = key==='sup'?'sups':'staffs'; db[k].push(v); render(); syncCloud('put'); } }
    function showImg(src) { document.getElementById('modal-content').src = src; document.getElementById('img-modal').style.display='flex'; }

    document.getElementById('shiftForm').onsubmit = async (e) => {
        e.preventDefault(); const ts = parseFloat(document.getElementById('in-total-sales').value)||0, ps = parseFloat(document.getElementById('in-pos-sales').value)||0;
        const ed = []; document.querySelectorAll('#exp-rows .batch-row').forEach(row => {
            const cat = row.querySelector('.e-cat').value, amt = parseFloat(row.querySelector('.e-amt').value)||0;
            if(amt>0) ed.push({cat, amt});
        });
        const img = await getImg(document.getElementById('in-file-shift'));
        forceSave({ id: Date.now(), type: 'day-sum', date: document.getElementById('in-date').value, totalSales: ts, pos: ps, cash: ts-ps, diff: parseFloat(document.getElementById('in-diff').value)||0, expDetails: ed, img });
        document.getElementById('exp-rows').innerHTML = ""; addExpRow(); e.target.reset(); resetInputsToToday();
    };

    document.getElementById('debtForm').onsubmit = async (e) => {
        e.preventDefault(); const type = document.getElementById('in-action').value, amt = parseFloat(document.getElementById('debt-amt').value)||0;
        const items = []; if(type==='buy') { document.querySelectorAll('#debt-tag-rows .batch-row').forEach(row => { items.push({ name: row.querySelector('.d-cat').value, amt: parseFloat(row.querySelector('.d-amt').value)||0 }); }); }
        const img = await getImg(document.getElementById('in-file-debt'));
        forceSave({ id: Date.now(), type, date: document.getElementById('debt-date').value, sup: document.getElementById('sel-sup').value, bill: document.getElementById('in-bill').value, amt, itemDetails: items, img });
        document.getElementById('debt-tag-rows').innerHTML = ""; e.target.reset(); resetInputsToToday();
    };

    document.getElementById('staffForm').onsubmit = async (e) => {
        e.preventDefault(); const img = await getImg(document.getElementById('in-file-staff'));
        forceSave({ id: Date.now(), type: document.getElementById('staff-type').value, date: document.getElementById('staff-date').value, staff: document.getElementById('sel-staff').value, amt: parseFloat(document.getElementById('staff-amt').value)||0, notes: document.getElementById('staff-notes').value, img });
        e.target.reset(); resetInputsToToday();
    };

    function exportExcel() {
        const rows = db.recs.map(r => ({ "æ—¥æœŸ": r.date, "ç±»å‹": r.type, "é‡‘é¢": (r.type==='day-sum'?r.totalSales:r.amt), "è¯¦æƒ…": JSON.stringify(r) }));
        const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ•°æ®");
        XLSX.writeFile(wb, "Bluefield_Data.xlsx");
    }
    function exportBackup() { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type:"application/json"})); a.download = "backup.json"; a.click(); }
    function importBackup() { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => { const r = new FileReader(); r.onload = e => { db = JSON.parse(e.target.result); render(); }; r.readAsText(e.target.files[0]); }; i.click(); }
</script>
</body>
</html>
