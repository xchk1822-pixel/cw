// ========== äº‘åŒæ­¥åŠŸèƒ½ï¼ˆFirebaseï¼‰==========
// Firebase é…ç½® - ä½ éœ€è¦æ›¿æ¢æˆè‡ªå·±çš„é…ç½®
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// åŠ¨æ€åŠ è½½ Firebase SDK
function loadFirebaseSDK() {
    return new Promise((resolve, reject) => {
        if (window.firebase) {
            resolve(window.firebase);
            return;
        }
        
        // åŠ è½½ Firebase æ ¸å¿ƒåº“
        const script1 = document.createElement('script');
        script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
        
        // åŠ è½½ Firestore åº“
        const script2 = document.createElement('script');
        script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js';
        
        // åŠ è½½ Storage åº“
        const script3 = document.createElement('script');
        script3.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js';
        
        // åŠ è½½ Auth åº“
        const script4 = document.createElement('script');
        script4.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js';
        
        script1.onload = () => {
            Promise.all([
                new Promise(r => { script2.onload = r; document.head.appendChild(script2); }),
                new Promise(r => { script3.onload = r; document.head.appendChild(script3); }),
                new Promise(r => { script4.onload = r; document.head.appendChild(script4); })
            ]).then(() => {
                // åˆå§‹åŒ– Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                resolve(firebase);
            });
        };
        
        document.head.appendChild(script1);
    });
}

// äº‘åŒæ­¥çŠ¶æ€
let cloudSyncEnabled = false;
let dbFirestore = null;
let dbStorage = null;
let unsubscribe = null;
let syncInProgress = false;
let lastSyncTime = null;

// åœ¨ç•Œé¢æ·»åŠ äº‘åŒæ­¥æ§åˆ¶æŒ‰é’®
function addCloudSyncControls() {
    const configBox = document.querySelector('.box:has(button[onclick="exportBackup()"])');
    if (!configBox) return;
    
    const syncDiv = document.createElement('div');
    syncDiv.id = 'cloud-sync-controls';
    syncDiv.innerHTML = `
        <hr>
        <div style="margin-bottom:10px;">
            <b style="font-size:13px;">â˜ï¸ äº‘åŒæ­¥è®¾ç½®</b>
            <div id="sync-status" style="font-size:11px; color:#666; margin:5px 0;">æœªè¿æ¥äº‘æœåŠ¡</div>
            <button onclick="initCloudSync()" id="cloud-init-btn" style="background:#2196F3; margin-bottom:5px;">ğŸ”Œ è¿æ¥äº‘æœåŠ¡</button>
            <button onclick="syncToCloud()" id="cloud-upload-btn" style="background:#4CAF50; margin-bottom:5px;" disabled>â¬†ï¸ æ‰‹åŠ¨ä¸Šä¼ åˆ°äº‘ç«¯</button>
            <button onclick="syncFromCloud()" id="cloud-download-btn" style="background:#FF9800; margin-bottom:5px;" disabled>â¬‡ï¸ ä»äº‘ç«¯æ¢å¤</button>
            <button onclick="toggleAutoSync()" id="auto-sync-btn" style="background:#9C27B0; color:white;" disabled>ğŸ”„ å¼€å¯è‡ªåŠ¨åŒæ­¥</button>
        </div>
    `;
    configBox.appendChild(syncDiv);
}

// åˆå§‹åŒ–äº‘åŒæ­¥
async function initCloudSync() {
    const initBtn = document.getElementById('cloud-init-btn');
    const statusDiv = document.getElementById('sync-status');
    
    try {
        initBtn.disabled = true;
        initBtn.innerText = 'â³ è¿æ¥ä¸­...';
        statusDiv.innerText = 'æ­£åœ¨åˆå§‹åŒ–äº‘æœåŠ¡...';
        
        await loadFirebaseSDK();
        
        dbFirestore = firebase.firestore();
        dbStorage = firebase.storage();
        
        // å°è¯•åŒ¿åç™»å½•ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸éœ€è¦ç”¨æˆ·æ³¨å†Œï¼‰
        await firebase.auth().signInAnonymously();
        
        cloudSyncEnabled = true;
        
        // å¯ç”¨åŒæ­¥æŒ‰é’®
        document.getElementById('cloud-upload-btn').disabled = false;
        document.getElementById('cloud-download-btn').disabled = false;
        document.getElementById('auto-sync-btn').disabled = false;
        
        statusDiv.innerHTML = 'âœ… å·²è¿æ¥åˆ°äº‘æœåŠ¡ <span style="color:#4CAF50;">â—</span>';
        initBtn.innerText = 'ğŸ”Œ å·²è¿æ¥';
        
        // æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™æç¤º
        checkCloudData();
        
    } catch (error) {
        console.error('äº‘åŒæ­¥åˆå§‹åŒ–å¤±è´¥:', error);
        statusDiv.innerHTML = 'âŒ è¿æ¥å¤±è´¥: ' + error.message;
        initBtn.disabled = false;
        initBtn.innerText = 'ğŸ”Œ é‡è¯•è¿æ¥';
    }
}

// æ£€æŸ¥äº‘ç«¯æ•°æ®
async function checkCloudData() {
    if (!dbFirestore) return;
    
    try {
        const snapshot = await dbFirestore.collection('financeData')
            .doc('mainData')
            .get();
        
        if (snapshot.exists) {
            const cloudData = snapshot.data();
            const statusDiv = document.getElementById('sync-status');
            statusDiv.innerHTML += `<br>ğŸ“… äº‘ç«¯æœ€åæ›´æ–°: ${new Date(cloudData.lastUpdate).toLocaleString()}`;
        }
    } catch (error) {
        console.error('æ£€æŸ¥äº‘ç«¯æ•°æ®å¤±è´¥:', error);
    }
}

// ä¸Šä¼ åˆ°äº‘ç«¯
async function syncToCloud() {
    if (!cloudSyncEnabled || !dbFirestore || syncInProgress) {
        alert('è¯·å…ˆè¿æ¥äº‘æœåŠ¡');
        return;
    }
    
    const statusDiv = document.getElementById('sync-status');
    
    try {
        syncInProgress = true;
        statusDiv.innerHTML = 'â« æ­£åœ¨ä¸Šä¼ æ•°æ®...';
        
        // å‡†å¤‡ä¸Šä¼ çš„æ•°æ®ï¼ˆç§»é™¤å¾ªç¯å¼•ç”¨ï¼‰
        const dataToUpload = {
            recs: db.recs || [],
            cats: db.cats || {},
            sups: db.sups || [],
            staffs: db.staffs || [],
            catOrder: db.catOrder || [],
            lastUpdate: new Date().toISOString(),
            version: '1.0'
        };
        
        // ä¸Šä¼ åˆ° Firestore
        await dbFirestore.collection('financeData').doc('mainData').set(dataToUpload);
        
        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä¸Šä¼ å›¾ç‰‡åˆ° Storageï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåªä¸Šä¼ æœ€è¿‘30å¤©çš„å›¾ç‰‡ï¼‰
        const recentImages = db.recs
            .filter(r => r.img && r.img.startsWith('data:image'))
            .slice(0, 50); // é™åˆ¶æ•°é‡é¿å…è¶…æ—¶
        
        if (recentImages.length > 0) {
            statusDiv.innerHTML += '<br>ğŸ“¸ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
            
            const imageRefs = [];
            for (const rec of recentImages) {
                if (rec.img && rec.img.startsWith('data:image')) {
                    const imageName = `images/${rec.id}.jpg`;
                    const imageRef = dbStorage.ref().child(imageName);
                    
                    // å°† base64 è½¬æ¢ä¸º Blob
                    const base64Data = rec.img.split(',')[1];
                    const blob = base64ToBlob(base64Data, 'image/jpeg');
                    
                    await imageRef.put(blob);
                    imageRefs.push(imageName);
                }
            }
            
            // ä¿å­˜å›¾ç‰‡å¼•ç”¨
            await dbFirestore.collection('financeData').doc('imageRefs').set({
                images: imageRefs,
                lastUpdate: new Date().toISOString()
            });
        }
        
        lastSyncTime = new Date();
        statusDiv.innerHTML = `âœ… ä¸Šä¼ æˆåŠŸï¼æœ€ååŒæ­¥: ${lastSyncTime.toLocaleTimeString()}`;
        
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        statusDiv.innerHTML = 'âŒ ä¸Šä¼ å¤±è´¥: ' + error.message;
    } finally {
        syncInProgress = false;
    }
}

// ä»äº‘ç«¯ä¸‹è½½
async function syncFromCloud() {
    if (!cloudSyncEnabled || !dbFirestore || syncInProgress) {
        alert('è¯·å…ˆè¿æ¥äº‘æœåŠ¡');
        return;
    }
    
    if (!confirm('âš ï¸ ä»äº‘ç«¯æ¢å¤å°†è¦†ç›–å½“å‰æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
    }
    
    const statusDiv = document.getElementById('sync-status');
    
    try {
        syncInProgress = true;
        statusDiv.innerHTML = 'â¬ æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½æ•°æ®...';
        
        // ä¸‹è½½ä¸»æ•°æ®
        const snapshot = await dbFirestore.collection('financeData').doc('mainData').get();
        
        if (!snapshot.exists) {
            statusDiv.innerHTML = 'âŒ äº‘ç«¯æ²¡æœ‰æ•°æ®';
            return;
        }
        
        const cloudData = snapshot.data();
        
        // æ›´æ–°æœ¬åœ°æ•°æ®åº“
        if (cloudData.recs) db.recs = cloudData.recs;
        if (cloudData.cats) db.cats = cloudData.cats;
        if (cloudData.sups) db.sups = cloudData.sups;
        if (cloudData.staffs) db.staffs = cloudData.staffs;
        if (cloudData.catOrder) db.catOrder = cloudData.catOrder;
        
        // å°è¯•ä¸‹è½½å›¾ç‰‡ï¼ˆç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦åˆ†æ‰¹ä¸‹è½½ï¼‰
        try {
            const imageRefsSnap = await dbFirestore.collection('financeData').doc('imageRefs').get();
            if (imageRefsSnap.exists) {
                statusDiv.innerHTML += '<br>ğŸ“¸ æ­£åœ¨ä¸‹è½½å›¾ç‰‡...';
                
                const imageRefs = imageRefsSnap.data().images || [];
                for (const imageName of imageRefs) {
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ ¹æ®å›¾ç‰‡IDåŒ¹é…åˆ°å¯¹åº”çš„è®°å½•
                }
            }
        } catch (imgError) {
            console.warn('å›¾ç‰‡ä¸‹è½½å¤±è´¥:', imgError);
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¹¶åˆ·æ–°ç•Œé¢
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        
        lastSyncTime = new Date();
        statusDiv.innerHTML = `âœ… æ¢å¤æˆåŠŸï¼æœ€ååŒæ­¥: ${lastSyncTime.toLocaleTimeString()}`;
        
        // åˆ·æ–°ç•Œé¢
        render();
        
    } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        statusDiv.innerHTML = 'âŒ ä¸‹è½½å¤±è´¥: ' + error.message;
    } finally {
        syncInProgress = false;
    }
}

// è¾…åŠ©å‡½æ•°ï¼šbase64 è½¬ Blob
function base64ToBlob(base64, contentType) {
    const byteCharacters = atob(base64);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, { type: contentType });
}

// è‡ªåŠ¨åŒæ­¥å¼€å…³
let autoSyncInterval = null;

function toggleAutoSync() {
    const btn = document.getElementById('auto-sync-btn');
    
    if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
        autoSyncInterval = null;
        btn.innerText = 'ğŸ”„ å¼€å¯è‡ªåŠ¨åŒæ­¥';
        btn.style.background = '#9C27B0';
    } else {
        autoSyncInterval = setInterval(() => {
            if (cloudSyncEnabled && !syncInProgress) {
                syncToCloud().catch(console.error);
            }
        }, 5 * 60 * 1000); // æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
        
        btn.innerText = 'â¹ï¸ å…³é—­è‡ªåŠ¨åŒæ­¥';
        btn.style.background = '#F44336';
    }
}

// ä¿®æ”¹ forceSave å‡½æ•°ä»¥æ”¯æŒè‡ªåŠ¨åŒæ­¥
const originalForceSave = forceSave;
forceSave = function(newRec) {
    originalForceSave(newRec);
    
    // å¦‚æœå¼€å¯äº†è‡ªåŠ¨åŒæ­¥ï¼Œåˆ™è‡ªåŠ¨ä¸Šä¼ 
    if (autoSyncInterval && cloudSyncEnabled && !syncInProgress) {
        // å»¶è¿Ÿä¸€ç‚¹åŒæ­¥ï¼Œé¿å…é¢‘ç¹æ“ä½œ
        setTimeout(() => syncToCloud(), 2000);
    }
};

// åœ¨é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ äº‘åŒæ­¥æ§ä»¶å¹¶è‡ªåŠ¨è¿æ¥
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        addCloudSyncControls();
        // è‡ªåŠ¨è¿æ¥äº‘æœåŠ¡
        setTimeout(() => {
            if (document.getElementById('cloud-init-btn')) {
                initCloudSync().then(() => {
                    // è¿æ¥æˆåŠŸåè‡ªåŠ¨å¼€å¯è‡ªåŠ¨åŒæ­¥
                    setTimeout(toggleAutoSync, 1000);
                });
            }
        }, 2000);
    }, 1000);
});

// ========== äº‘åŒæ­¥åŠŸèƒ½ç»“æŸ ==========
