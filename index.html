<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bluefield é¤å…è´¢åŠ¡ç®¡ç† ç³»ç»Ÿï¼ˆäº‘ç«¯åŒæ­¥ç‰ˆï¼‰</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #3f51b5; --bg: #f5f7fa; --success: #43a047; --danger: #e53935; --warning: #ffa000; --info: #00acc1; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .box { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .header { background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 20px; }
        #clock { position: absolute; right: 20px; font-size: 14px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 15px; }
        .card { padding: 15px; border-radius: 6px; color: white; text-align: center; }
        .bg-rev { background: var(--success); } .bg-total { background: #546e7a; } .bg-exp { background: var(--danger); } .bg-profit { background: #fb8c00; } .bg-debt { background: #1e88e5; }
        .val-big { font-size: 20px; font-weight: bold; margin: 5px 0; }
        .val-small { font-size: 11px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 8px 10px; text-align: left; font-size: 13px; word-break: break-all; }
        th { background: #f8f9fa; color: #666; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .cal-day { border: 1px solid #eee; padding: 5px 2px; text-align: center; border-radius: 4px; font-size: 11px; background: #fff; min-height: 40px;}
        .cal-day.has-data { background: #e8f5e9; border-color: #c8e6c9; }
        .tag-box { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .tag { background: #eceff1; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 5px; justify-content: space-between;}
        .tag b { color: #e53935; cursor: pointer; font-size: 16px; }
        .move-btn { cursor: pointer; color: var(--primary); font-weight: bold; padding: 0 3px; font-size: 14px; }
        .batch-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .search-bar { background: #e8eaf6; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        #img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        #img-modal img { max-width:90%; max-height:90%; border:3px solid white; }
        .sub-row { background: #fafafa; font-size: 12px; color: #777; }
        .capture-area { border: 2px dashed #ccc; padding: 10px; margin: 10px 0; display: none; text-align: center; }
        video { width: 100%; border-radius: 4px; background: #000; }

        .txt-rev-line { color: #2e7d32; font-weight: bold; border-bottom: 1px solid #f0f0f0; padding-bottom: 2px; margin-bottom: 2px; display: block; }
        .txt-exp-line { color: #d32f2f; font-size: 12px; display: block; }

        @media print {
            .no-print, aside, .header, .grid-5, .search-bar, .tag-box, button { display: none !important; }
            body { background: white; padding: 0; margin: 0; font-size: 10px; }
            .main-layout { display: block; }
            .box { box-shadow: none; border: 1px solid #000; margin-bottom: 10px; padding: 5px; border-radius: 0; }
            table { font-size: 10px; margin-top: 5px; }
            th, td { padding: 3px 5px; border: 1px solid #333; color: #000 !important; }
            .card, .bg-rev, .bg-total, .bg-exp, .bg-profit, .bg-debt { color: #000; background: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body onload="init()">

<div id="img-modal" onclick="this.style.display='none'"><img id="modal-content"></div>

<div class="header no-print">
    <h2 style="margin:0; font-size: 18px;">Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿï¼ˆäº‘ç«¯åŒæ­¥ç‰ˆï¼‰</h2>
    <div id="clock"></div>
</div>

<div class="grid-5 no-print">
    <div class="card bg-total"><div>ç´¯è®¡è¥ä¸šæ€»é¢</div><div class="val-big" id="h-all-rev">C$ 0</div><div class="val-small">æ‰€æœ‰å•æ®æ€»å’Œ</div></div>
    <div class="card bg-rev"><div>åŒºé—´è¥æ”¶æ€»è®¡</div><div class="val-big" id="h-mon-rev">C$ 0</div><div class="val-small" id="h-pos-info">ç° C$ 0 | PO C$ 0</div></div>
    <div class="card bg-exp"><div>åŒºé—´ç´¯è®¡æ”¯å‡º</div><div class="val-big" id="h-mon-exp">C$ 0</div><div class="val-small">ä»…åŒ…å«è¥ä¸šæ”¯å‡ºåŠè¿˜æ¬¾</div></div>
    <div class="card bg-profit"><div>åŒºé—´æ€»ç›ˆäº</div><div class="val-big" id="h-profit">C$ 0</div><div class="val-small" style="color:#fff">æ€»é¢ - æ”¯å‡º + è¯¯å·®</div></div>
    <div class="card bg-debt"><div>åº”ä»˜æ€»æ¬ æ¬¾</div><div class="val-big" id="h-debt">C$ 0</div><div class="val-small" style="color:#ffeb3b">ä¾›åº”å•†å¾…ç»“æ€»é¢</div></div>
</div>

<div class="main-layout">
    <aside class="no-print">
        <div class="box">
            <b style="font-size:14px; color:var(--primary);">ğŸ—“ï¸ æœˆåº¦æ—¥å†</b>
            <input type="month" id="cal-picker" onchange="render()">
            
            <div class="calendar-grid" style="font-weight:bold; background:#e8eaf6; border-radius:4px; margin-bottom:5px; min-height:auto; text-align:center;">
                <div style="color:var(--danger); padding:5px 0;">æ—¥</div>
                <div style="padding:5px 0;">ä¸€</div>
                <div style="padding:5px 0;">äºŒ</div>
                <div style="padding:5px 0;">ä¸‰</div>
                <div style="padding:5px 0;">å››</div>
                <div style="padding:5px 0;">äº”</div>
                <div style="color:var(--danger); padding:5px 0;">å…­</div>
            </div>
            
            <div id="calendar" class="calendar-grid"></div>
        </div>
        
        <div class="box">
            <b style="font-size:14px;">æ•°æ®å½•å…¥ä¸æ¨¡å—åˆ‡æ¢</b>
            <select id="main-mode" onchange="switchForm()">
                <option value="shift">ğŸ® æ¯æ—¥äº¤ç­ç»“è½¬ (å°ç¥¨æ¨¡å¼)</option>
                <option value="debt">ğŸ“Š ä¾›åº”å•†è´¦ç›® (æŒ‚è´¦/è¿˜æ¬¾)</option>
                <option value="staff">ğŸ‘¤ å‘˜å·¥è–ªèµ„/å€Ÿæ¬¾å½•å…¥</option>
            </select>
            <hr>
            
            <div id="capture-container" class="capture-area">
                <video id="video" autoplay muted></video>
                <button onclick="takeScreenshot()" style="background:var(--danger); margin-top:5px;">ç¡®è®¤æˆªå–å½“å‰ç”»é¢</button>
                <button onclick="closeCapture()" style="background:#666;">å–æ¶ˆ</button>
            </div>

            <form id="shiftForm">
                <input type="date" id="in-date" required>
                <input type="number" id="in-total-sales" step="0.01" placeholder="VENTAS (å°ç¥¨æ€»é¢)" required oninput="calcShift()">
                <input type="number" id="in-pos-sales" step="0.01" placeholder="POS (åˆ·å¡)" required oninput="calcShift()">
                <input type="number" id="in-diff" step="0.01" placeholder="Dif (è¯¯å·®)" oninput="calcShift()">
                <div id="exp-rows"></div>
                <button type="button" onclick="addExpRow()" style="background:#90a4ae; font-size:11px; padding:6px;">+ å¢åŠ æ”¯å‡ºé¡¹</button>
                <div id="shift-preview" style="background:#fff3e0; padding:10px; border-radius:4px; margin:10px 0; font-size:12px;">ç­‰å¾…å½•å…¥...</div>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-shift" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-shift')" style="width:80px; background:var(--info); font-size:11px;">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--success)">ä¿å­˜äº¤ç­</button>
            </form>

            <form id="debtForm" style="display:none;">
                <input type="date" id="debt-date">
                <select id="sel-sup"></select>
                <input type="text" id="in-bill" placeholder="å•å·" required>
                <select id="in-action" onchange="toggleDebtHelper()"><option value="buy">æŒ‚è´¦é‡‡è´­</option><option value="pay">è¿˜æ¬¾æ”¯ä»˜</option></select>
                <div id="debt-helper" style="background:#f5f5f5; padding:8px; border-radius:4px; margin:5px 0;">
                    <div id="debt-tag-rows"></div>
                    <button type="button" onclick="addDebtTagRow()" style="background:#ffb74d; font-size:10px; padding:2px; color:#333;">+ å¢åŠ æ±‡æ€»é¡¹</button>
                </div>
                <input type="number" id="debt-amt" step="0.01" placeholder="æ€»é‡‘é¢" required>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-debt" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-debt')" style="width:80px; background:var(--info); font-size:11px;">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--info)">ä¿å­˜å•æ®</button>
            </form>

            <form id="staffForm" style="display:none;">
                <input type="date" id="staff-date">
                <select id="sel-staff"></select>
                <select id="staff-type"><option value="salary">å‘æ”¾å·¥èµ„</option><option value="loan">å‘˜å·¥å€Ÿæ¬¾</option></select>
                <input type="number" id="staff-amt" step="0.01" placeholder="é‡‘é¢" required>
                <input type="text" id="staff-notes" placeholder="å¤‡æ³¨">
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-staff" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-staff')" style="width:80px; background:var(--info); font-size:11px;">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--warning); color:#333;">ä¿å­˜å‘˜å·¥è®°å½•</button>
            </form>
        </div>

        <div class="box no-print">
            <b style="font-size:13px;">âš™ï¸ é…ç½®ç®¡ç†</b>
            <div style="margin-top:10px;"><small>ğŸ‘¥ å‘˜å·¥</small></div>
            <div id="list-staff" class="tag-box"></div>
            <button onclick="addSetting('staff')" style="font-size:10px; background:#fb8c00; padding:4px;">+ å‘˜å·¥</button>
            <hr>
            <div><small>ğŸš› ä¾›åº”å•†</small></div>
            <div id="list-sup" class="tag-box"></div>
            <button onclick="addSetting('sup')" style="font-size:10px; background:#607d8b; padding:4px;">+ ä¾›åº”å•†</button>
            <hr>
            <div><small>ğŸ“‚ æ”¯å‡º/è´§å“åˆ†ç±» (å¯è°ƒé¡ºåº)</small></div>
            <div id="list-cat" class="tag-box" style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
            <button onclick="addParentCat()" style="font-size:10px; background:var(--primary); padding:4px;">+ æ–°å¢å¤§ç±»</button>
            <hr>
            <button onclick="exportBackup()" style="background:#673ab7; margin-bottom:5px;">ğŸ’¾ å¯¼å‡ºå…¨é‡æ•°æ®åŒ…</button>
            <button onclick="importBackup()" style="background:#607d8b; margin-bottom:15px;">ğŸ“¥ å¯¼å…¥å…¨é‡æ•°æ®åŒ…</button>
            <button onclick="exportExcel()" style="background:#2e7d32;">å¯¼å‡ºExcelè¡¨æ ¼</button>
            
            <!-- Firebase äº‘ç«¯åŒæ­¥çŠ¶æ€ -->
            <hr>
            <div style="margin-top:10px; padding:8px; background:#e8f5e9; border-radius:4px; font-size:12px;" id="cloud-status">
                â˜ï¸ äº‘ç«¯åŒæ­¥: è¿æ¥ä¸­...
            </div>
            
            <!-- å¯†ç ä¿æŠ¤è®¾ç½® -->
            <hr>
            <div style="margin-top:10px; padding:8px; background:#fff3e0; border-radius:4px; font-size:12px;">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <b style="color:#e65100;">ğŸ”’ ç¼–è¾‘ä¿æŠ¤</b>
                    <span id="lock-status" style="font-size:11px; color:#666;">(å·²é”å®š)</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="password" id="password-input" placeholder="è¾“å…¥å¯†ç " style="flex:2; margin:0; padding:8px;">
                    <button onclick="unlockWithPassword()" style="flex:1; margin:0; padding:8px; background:#fb8c00;">è§£é”</button>
                </div>
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <button onclick="lockSystem()" style="flex:1; padding:5px; background:#757575;">é”å®š</button>
                    <button onclick="setNewPassword()" style="flex:1; padding:5px; background:#0288d1;">è®¾ç½®å¯†ç </button>
                </div>
            </div>
        </div>
    </aside>

    <main>
        <div class="search-bar no-print">
            <div style="flex:1;"><input type="date" id="f-start" onchange="render()"></div>
            <div style="flex:1;"><input type="date" id="f-end" onchange="render()"></div>
            <div style="flex:2;"><input type="text" id="f-key" placeholder="è¾“å…¥åç§°æˆ–å…³é”®å­—æŸ¥è¯¢..." oninput="render()"></div>
            <button onclick="window.print()" style="width:80px; background:#607d8b;">æ‰“å°</button>
        </div>

        <div id="view-shift">
            <div class="box">
                <b style="color:var(--success); font-size:15px;">ğŸ“Š è¥ä¸šç»Ÿè®¡æ±‡æ€»</b>
                <div style="display: flex; gap: 20px; margin-top:10px;">
                    <div style="flex: 1;">
                        <table>
                            <thead><tr><th>è¥æ”¶ç±»å‹</th><th>é‡‘é¢</th></tr></thead>
                            <tbody id="revTbody"></tbody>
                        </table>
                        <b style="color:#e65100; font-size:13px; margin-top:15px; display:block;">ğŸ” å†…éƒ¨è´§å“å‚è€ƒæ±‡æ€»</b>
                        <table>
                            <thead><tr><th>è´§å“</th><th>æ±‡æ€»é¢</th></tr></thead>
                            <tbody id="itemTbody"></tbody>
                        </table>
                    </div>
                    <div style="flex: 1.5;">
                        <table>
                            <thead><tr><th>æ”¯å‡ºæ˜ç»†æ±‡æ€»</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead>
                            <tbody id="expTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-debt" style="display:none;">
            <div class="box">
                <b style="color:var(--primary); font-size:15px;">ğŸš› ä¾›åº”å•†å¯¹è´¦æ˜ç»† (æŒ‰å•æ®å·å½’ç±»)</b>
                <table>
                    <thead><tr><th style="width:25%">ä¾›åº”å•†</th><th style="width:20%">å•æ®å·</th><th>åº”ä»˜é¢</th><th>å·²ä»˜é¢</th><th style="width:20%">å‰©ä½™æ¬ æ¬¾</th></tr></thead>
                    <tbody id="billTbody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-staff" style="display:none;">
            <div class="box">
                <b style="color:var(--warning); font-size:15px;">ğŸ‘¤ å‘˜å·¥è–ªèµ„/å€Ÿæ¬¾æ±‡æ€»ç»Ÿè®¡ (å…¨å‘˜åŠæ˜ç»†)</b>
                <table>
                    <thead><tr><th>å‘˜å·¥å§“å</th><th>æœŸé—´åº”å‘å·¥èµ„</th><th>æœŸé—´ç´¯è®¡å€Ÿæ¬¾</th><th style="background:#fff3e0">å®è¡¥å·®é¢(åº”ä»˜)</th></tr></thead>
                    <tbody id="staffTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="box">
            <b id="list-title">ğŸ“‘ ä¸šåŠ¡æµæ°´æ˜ç»†</b>
            <table>
                <thead>
                    <tr>
                        <th style="width:90px">æ—¥æœŸ</th>
                        <th style="width:50px">ç±»å‹</th>
                        <th>æ˜ç»†è¯¦æƒ… (ä¸Šæ”¶ä¸‹æ”¯)</th>
                        <th style="width:90px">æ€»é‡‘é¢</th>
                        <th class="no-print" style="width:40px">å‡­è¯</th>
                        <th class="no-print" style="width:40px">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
    // ==================== Firebase é…ç½®ï¼ˆä½ çš„çœŸå®é…ç½®ï¼‰====================
    const firebaseConfig = {
        apiKey: "AIzaSyC3ADmd485_ITMpwaLbLDtctrROiwLHbHw",
        authDomain: "restaurant-cw.firebaseapp.com",
        databaseURL: "https://restaurant-cw-default-rtdb.firebaseio.com",
        projectId: "restaurant-cw",
        storageBucket: "restaurant-cw.firebasestorage.app",
        messagingSenderId: "980204506513",
        appId: "1:980204506513:web:ae195605300782435d9e30",
        measurementId: "G-43206TF3VJ"
    };

    // ==================== å…¨å±€å˜é‡ ====================
    const STORAGE_KEY = "BF_DB_V1299";
    const CUR = "C$ ";
    let currentTargetInputId = "";
    let capturedImgData = null;
    
    // é»˜è®¤æ•°æ®
    let db = { 
        recs: [], 
        cats: {"è‚‰ç±»":["é¸¡è‚‰","ç‰›è‚‰"],"å¤–å–":["å¤–å–"],"æ‚è´¹":["å…¶ä»–"]}, 
        sups: ['é»˜è®¤ä¾›åº”å•†'], 
        staffs: ['é»˜è®¤å‘˜å·¥'], 
        catOrder: ["è‚‰ç±»","å¤–å–","æ‚è´¹"] 
    };

    // Firebase ç›¸å…³
    let firebaseApp = null;
    let firestore = null;
    let firebaseLoaded = false;
    let syncInProgress = false;
    let autoSyncInterval = null;

    // ==================== å¯†ç ä¿æŠ¤å˜é‡ ====================
    const DEFAULT_PASSWORD = "123456";
    let currentPassword = localStorage.getItem('BF_PASSWORD') || DEFAULT_PASSWORD;
    let isUnlocked = false;

    // ==================== Firebase åˆå§‹åŒ– ====================
    async function initFirebase() {
        try {
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: åŠ è½½SDK...';
            
            // åŠ è½½ Firebase SDK
            await loadFirebaseSDK();
            
            // åˆå§‹åŒ– Firebase
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firestore = firebase.firestore();
            
            // åŒ¿åç™»å½•ï¼ˆä¸éœ€è¦ç”¨æˆ·æ“ä½œï¼‰
            await firebase.auth().signInAnonymously();
            
            firebaseLoaded = true;
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âœ… å·²è¿æ¥';
            
            // ä»äº‘ç«¯åŠ è½½æ•°æ®
            await loadFromCloud();
            
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
            document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âŒ è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨';
            // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®
            loadFromLocal();
        }
    }

    // åŠ è½½ Firebase SDK
    function loadFirebaseSDK() {
        return new Promise((resolve, reject) => {
            if (window.firebase) {
                resolve();
                return;
            }
            
            const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
            
            script1.onload = () => {
                const script2 = document.createElement('script');
                script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js';
                
                const script3 = document.createElement('script');
                script3.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js';
                
                Promise.all([
                    new Promise(r => { script2.onload = r; document.head.appendChild(script2); }),
                    new Promise(r => { script3.onload = r; document.head.appendChild(script3); })
                ]).then(resolve).catch(reject);
            };
            
            script1.onerror = reject;
            document.head.appendChild(script1);
        });
    }

    // ==================== æ•°æ®åŒæ­¥å‡½æ•° ====================
    async function loadFromCloud() {
    if (!firebaseLoaded || !firestore) return false;
    
    try {
        const doc = await firestore.collection('financeData').doc('mainData').get();
        
        if (doc.exists) {
            const cloudData = doc.data();
            // ç§»é™¤ lastSync å­—æ®µï¼Œåªä¿ç•™æ•°æ®
            delete cloudData.lastSync;
            
            // æ¯”è¾ƒæœ¬åœ°å’Œäº‘ç«¯ï¼Œå–æ›´æ–°çš„é‚£ä¸ª
            const localData = localStorage.getItem(STORAGE_KEY);
            if (localData) {
                const localParsed = JSON.parse(localData);
                // å¦‚æœæœ‰æ—¶é—´æˆ³å¯ä»¥æ¯”è¾ƒï¼Œç®€å•èµ·è§å…ˆç”¨æœ¬åœ°
                console.log("ä½¿ç”¨æœ¬åœ°æ•°æ®");
                db = localParsed;
                document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âœ… ä½¿ç”¨æœ¬åœ°æ•°æ®';
            } else {
                // æœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œç”¨äº‘ç«¯çš„
                db = cloudData;
                if (!db.catOrder) db.catOrder = Object.keys(db.cats || {});
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âœ… å·²åŠ è½½äº‘ç«¯æ•°æ®';
            }
            render();
            return true;
        } else {
            // äº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä¸Šä¼ æœ¬åœ°
            await saveToCloud();
            return false;
        }
    } catch (error) {
        console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
        return false;
    }
}

    // ==================== å¯†ç ä¿æŠ¤åŠŸèƒ½ ====================
    function initPasswordProtection() {
        const lockStatus = document.getElementById('lock-status');
        if (lockStatus) {
            lockStatus.innerText = isUnlocked ? '(å·²è§£é”)' : '(å·²é”å®š)';
            lockStatus.style.color = isUnlocked ? '#4CAF50' : '#e65100';
        }
        
        // å¼€å§‹ç›‘æ§æ‰€æœ‰ç¼–è¾‘æ“ä½œ
        monitorEditOperations();
    }

    // ç›‘æ§æ‰€æœ‰ç¼–è¾‘æ“ä½œ
    function monitorEditOperations() {
        // æ‹¦æˆªæ‰€æœ‰æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', function(e) {
            // è·å–è¢«ç‚¹å‡»çš„å…ƒç´ 
            const target = e.target;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘ç›¸å…³çš„æŒ‰é’®
            const isEditButton = 
                target.closest('button[onclick*="add"]') || // æ·»åŠ æŒ‰é’®
                target.closest('button[onclick*="del"]') || // åˆ é™¤æŒ‰é’®
                target.closest('button[onclick*="save"]') || // ä¿å­˜æŒ‰é’®
                target.closest('[onclick*="move"]') || // ç§»åŠ¨æŒ‰é’®
                target.closest('[onclick*="rename"]') || // é‡å‘½å
                target.closest('[contenteditable="true"]') || // å¯ç¼–è¾‘å†…å®¹
                target.closest('.tag b') || // åˆ é™¤æ ‡ç­¾
                target.closest('button[type="submit"]') || // æäº¤æŒ‰é’®
                (target.tagName === 'BUTTON' && !target.closest('#password-input') && 
                 !target.closest('button[onclick="unlockWithPassword()"]') &&
                 !target.closest('button[onclick="lockSystem()"]') &&
                 !target.closest('button[onclick="setNewPassword()"]') &&
                 !target.closest('button[onclick="exportExcel()"]') &&
                 !target.closest('button[onclick="exportBackup()"]') &&
                 !target.closest('button[onclick="importBackup()"]') &&
                 !target.closest('button[onclick="window.print()"]'));
            
            if (isEditButton && !isUnlocked) {
                e.preventDefault();
                e.stopPropagation();
                alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ç¼–è¾‘ï¼');
                return false;
            }
        }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿å…ˆæ‰§è¡Œ
        
        // æ‹¦æˆªè¡¨å•æäº¤
        const forms = ['shiftForm', 'debtForm', 'staffForm'];
        forms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!isUnlocked) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿å­˜ï¼');
                        return false;
                    }
                }, true);
            }
        });
        
        // æ‹¦æˆª contenteditable çš„è¾“å…¥
        document.addEventListener('keydown', function(e) {
            const target = e.target;
            if (target.getAttribute('contenteditable') === 'true' && !isUnlocked) {
                e.preventDefault();
                e.stopPropagation();
                alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ç¼–è¾‘ï¼');
                return false;
            }
        }, true);
    }

    // è§£é”ç³»ç»Ÿ
    function unlockWithPassword() {
        const input = document.getElementById('password-input');
        const enteredPassword = input.value;
        
        if (enteredPassword === currentPassword) {
            isUnlocked = true;
            document.getElementById('lock-status').innerText = '(å·²è§£é”)';
            document.getElementById('lock-status').style.color = '#4CAF50';
            document.getElementById('password-input').value = '';
            document.getElementById('password-hint').innerText = 'âœ… å·²è§£é”ï¼Œå¯ä»¥è¿›è¡Œç¼–è¾‘æ“ä½œ';
            document.getElementById('password-hint').style.color = '#4CAF50';
            
            // 3åˆ†é’Ÿåè‡ªåŠ¨é”å®š
            setTimeout(() => {
                if (isUnlocked) {
                    lockSystem();
                }
            }, 3 * 60 * 1000);
        } else {
            alert('âŒ å¯†ç é”™è¯¯ï¼');
            document.getElementById('password-hint').innerText = 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
            document.getElementById('password-hint').style.color = '#f44336';
        }
    }

    // é”å®šç³»ç»Ÿ
    function lockSystem() {
        isUnlocked = false;
        document.getElementById('lock-status').innerText = '(å·²é”å®š)';
        document.getElementById('lock-status').style.color = '#e65100';
        document.getElementById('password-hint').innerText = 'ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œéœ€è¦å¯†ç æ‰èƒ½ç¼–è¾‘';
        document.getElementById('password-hint').style.color = '#999';
    }

    // è®¾ç½®æ–°å¯†ç 
    function setNewPassword() {
        if (!isUnlocked) {
            alert('ğŸ”’ è¯·å…ˆè§£é”ç³»ç»Ÿæ‰èƒ½ä¿®æ”¹å¯†ç ï¼');
            return;
        }
        
        const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘4ä½ï¼‰:', '');
        if (newPassword) {
            if (newPassword.length < 4) {
                alert('å¯†ç è‡³å°‘éœ€è¦4ä½ï¼');
                return;
            }
            const confirmPassword = prompt('è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ç¡®è®¤:', '');
            if (confirmPassword === newPassword) {
                currentPassword = newPassword;
                localStorage.setItem('BF_PASSWORD', newPassword);
                alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼æ–°å¯†ç å·²ç”Ÿæ•ˆã€‚');
                document.getElementById('password-hint').innerHTML = `âœ… å¯†ç å·²ä¿®æ”¹ï¼Œæ–°å¯†ç ç”Ÿæ•ˆ`;
            } else {
                alert('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
            }
        }
    }

    // ==================== åŸæœ‰å‡½æ•° ====================
    function resetInputsToToday() {
        const d = new Date().toISOString().split('T')[0];
        document.getElementById('cal-picker').value = d.substring(0,7);
        document.getElementById('in-date').value = d;
        document.getElementById('debt-date').value = d;
        document.getElementById('staff-date').value = d;
        capturedImgData = null; 
    }

   function init() {
    // å¼ºåˆ¶ä»æœ¬åœ°åŠ è½½æ•°æ®
    const saved = localStorage.getItem('BF_DB_V1299');
    if (saved) {
        try {
            db = JSON.parse(saved);
            if (!db.catOrder) db.catOrder = Object.keys(db.cats || {});
            console.log("ä»æœ¬åœ°åŠ è½½æ•°æ®æˆåŠŸ");
        } catch(e) {
            console.error("è§£æå¤±è´¥", e);
        }
    }
    
    // æ¸²æŸ“é¡µé¢
    render();
    
    // å†åˆå§‹åŒ– Firebase
    initFirebase();
    
    resetInputsToToday();
    const d = new Date().toISOString().split('T')[0];
    document.getElementById('f-start').value = d.substring(0,8)+'01';
    document.getElementById('f-end').value = d;
    addExpRow();
    
    setInterval(() => { 
        const now = new Date(); 
        document.getElementById('clock').innerText = now.toLocaleString(); 
    }, 1000);
    
    // æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
    autoSyncInterval = setInterval(() => {
        if (firebaseLoaded && !syncInProgress) {
            saveToCloud();
        }
    }, 5 * 60 * 1000);
    
    // åˆå§‹åŒ–å¯†ç ä¿æŠ¤
    setTimeout(initPasswordProtection, 2000);
}
    async function startCapture(inputId) {
        currentTargetInputId = inputId; 
        const container = document.getElementById('capture-container'); 
        const video = document.getElementById('video'); 
        container.style.display = 'block';
        try { 
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false }); 
            video.srcObject = stream; 
        } catch (err) { 
            alert("æ— æ³•è·å–æƒé™"); 
            container.style.display = 'none'; 
        }
    }
    
    function closeCapture() { 
        const video = document.getElementById('video'); 
        if (video.srcObject) { 
            video.srcObject.getTracks().forEach(track => track.stop()); 
        } 
        document.getElementById('capture-container').style.display = 'none'; 
    }
    
    function takeScreenshot() { 
        const video = document.getElementById('video'); 
        const canvas = document.createElement('canvas'); 
        canvas.width = 1280; 
        canvas.height = (video.videoHeight / video.videoWidth) * 1280; 
        const ctx = canvas.getContext('2d'); 
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height); 
        capturedImgData = canvas.toDataURL('image/jpeg', 0.6); 
        closeCapture(); 
        alert("ğŸ–¥ï¸ æˆªå›¾å·²å°±ç»ª"); 
    }

    async function forceSave(newRec) {
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿å­˜ï¼');
            return;
        }
        db.recs.push(newRec); 
        await updateDB(db);
        alert("âœ… ä¿å­˜æˆåŠŸ"); 
    }

    function switchForm() {
        const mode = document.getElementById('main-mode').value;
        document.getElementById('shiftForm').style.display = (mode === 'shift' ? 'block' : 'none');
        document.getElementById('debtForm').style.display = (mode === 'debt' ? 'block' : 'none');
        document.getElementById('staffForm').style.display = (mode === 'staff' ? 'block' : 'none');
        document.getElementById('view-shift').style.display = (mode === 'shift' ? 'block' : 'none');
        document.getElementById('view-debt').style.display = (mode === 'debt' ? 'block' : 'none');
        document.getElementById('view-staff').style.display = (mode === 'staff' ? 'block' : 'none');
        render();
    }

    function render() {
        // åŸæœ‰ render å‡½æ•°å®Œå…¨ä¸å˜
        const mode = document.getElementById('main-mode').value;
        const fS = document.getElementById('f-start').value, fE = document.getElementById('f-end').value, fK = document.getElementById('f-key').value.toLowerCase();
        
        document.getElementById('list-sup').innerHTML = db.sups.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('sup',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-sup').innerHTML = db.sups.map(s=>`<option>${s}</option>`).join('');
        document.getElementById('list-staff').innerHTML = db.staffs.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('staff',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-staff').innerHTML = db.staffs.map(s=>`<option>${s}</option>`).join('');
        
        let catH = "";

        db.catOrder.forEach((p, pi) => {
            catH += `<div style="font-weight:bold; font-size:12px; margin-top:8px; color:#3f51b5; display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <span contenteditable="true" 
                                  onblur="renameParentCat('${p}', this.innerText)" 
                                  onkeydown="if(event.keyCode==13){event.preventDefault();this.blur();}"
                                  style="border-bottom:1px dashed #3f51b5; cursor:text; padding:0 3px;">${p}</span>
                            <small onclick="addChildCat('${p}')" style="cursor:pointer; color:green; margin-left:5px;">[+]</small>
                        </span>
                        <span>
                            <span class="move-btn" onclick="moveParent(${pi},-1)">â†‘</span>
                            <span class="move-btn" onclick="moveParent(${pi},1)">â†“</span>
                            <small onclick="delParentCat('${p}')" style="cursor:pointer; color:red; margin-left:5px;">[Ã—]</small>
                        </span>
                    </div>`;
            
            if(db.cats[p]) db.cats[p].forEach((c, ci) => { 
                catH += `<div class="tag" style="margin-left:10px;">
                            <span contenteditable="true" 
                                  onblur="renameChildCat('${p}', '${c}', this.innerText)"
                                  onkeydown="if(event.keyCode==13){event.preventDefault();this.blur();}"
                                  style="cursor:text; min-width:30px; display:inline-block;">${c}</span>
                            <span>
                                <span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},-1)">â†‘</span>
                                <span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},1)">â†“</span>
                                <b onclick="delChildCat('${p}',${ci})">Ã—</b>
                            </span>
                        </div>`; 
            });
        });       
        document.getElementById('list-cat').innerHTML = catH;

        let stats = { mCash:0, mPos:0, mExp:0, mSales:0, aSales:0, tDebt:0, mDiff:0 };
        let calData = {}, expAgg = {}, itemAgg = {}, staffSummary = {}, billAgg = {};
        db.staffs.forEach(s => staffSummary[s] = {sal:0, loan:0});

        db.recs.forEach(r => {
            if(r.type === 'buy') stats.tDebt += (r.amt||0);
            if(r.type === 'pay') stats.tDebt -= (r.amt||0);
            if(r.type === 'day-sum') stats.aSales += (r.totalSales||0);
            const inDate = (r.date >= fS && r.date <= fE);
            if(inDate) {
                const isDebtModule = (r.type === 'buy' || r.type === 'pay');
                const isMatch = !fK || (isDebtModule ? (r.sup && r.sup.toLowerCase() === fK) : JSON.stringify(r).toLowerCase().includes(fK));
                
                if(isDebtModule && isMatch) {
                    const bKey = `${r.sup}_${r.bill || 'æ— å•å·'}`;
                    if(!billAgg[bKey]) billAgg[bKey] = { sup: r.sup, bill: r.bill || 'æ— å•å·', buy: 0, pay: 0 };
                    if(r.type === 'buy') billAgg[bKey].buy += (r.amt||0);
                    if(r.type === 'pay') billAgg[bKey].pay += (r.amt||0);
                }
                
                if(r.type === 'salary' && staffSummary[r.staff]) staffSummary[r.staff].sal += (r.amt||0); 
                else if(r.type === 'loan' && staffSummary[r.staff]) staffSummary[r.staff].loan += (r.amt||0);
                
               if(r.type === 'day-sum') {
    stats.mCash += (r.cash||0); stats.mPos += (r.pos||0); stats.mSales += (r.totalSales||0); stats.mDiff += (r.diff||0);
    if(r.expDetails) r.expDetails.forEach(ed => { stats.mExp += ed.amt; expAgg[ed.cat] = (expAgg[ed.cat]||0)+ed.amt; let iname = ed.cat.split(':')[1]; itemAgg[iname] = (itemAgg[iname]||0)+ed.amt; });
} else if(r.type === 'pay') { 
    stats.mExp += (r.amt||0); 
    expAgg['è¿˜æ¬¾:ä¾›åº”å•†'] = (expAgg['è¿˜æ¬¾:ä¾›åº”å•†']||0)+(r.amt||0); 
} else if(r.type === 'buy' && r.itemDetails) {
    // å¤„ç†ä¾›åº”å•†æŒ‚è´¦çš„è´§å“
    r.itemDetails.forEach(item => {
        itemAgg[item.name] = (itemAgg[item.name]||0) + item.amt;
    });
} 
            }
            if(inDate && r.type==='day-sum' && r.date.startsWith(document.getElementById('cal-picker').value)) calData[r.date] = (calData[r.date]||0)+(r.totalSales||0);
        });

        document.getElementById('billTbody').innerHTML = Object.values(billAgg).map(b => `<tr><td>${b.sup}</td><td>${b.bill}</td><td>${CUR}${b.buy.toFixed(1)}</td><td>${CUR}${b.pay.toFixed(1)}</td><td style="color:${(b.buy-b.pay)>0?'red':'green'}">${CUR}${(b.buy-b.pay).toFixed(1)}</td></tr>`).join('');
        const currentProfit = stats.mSales - stats.mExp + stats.mDiff;
        document.getElementById('h-all-rev').innerText = CUR + stats.aSales.toFixed(0);
        document.getElementById('h-mon-rev').innerText = CUR + (stats.mCash + stats.mPos).toFixed(1);
        document.getElementById('h-pos-info').innerHTML = `<span style="color:#ffeb3b">ç° ${CUR}${stats.mCash.toFixed(1)}</span> | <span style="color:#ffeb3b">PO ${CUR}${stats.mPos.toFixed(1)}</span>`;     
        document.getElementById('h-mon-exp').innerText = CUR + stats.mExp.toFixed(1);
        document.getElementById('h-profit').innerText = CUR + currentProfit.toFixed(1);
        document.getElementById('h-debt').innerText = CUR + stats.tDebt.toFixed(1);

        document.getElementById('revTbody').innerHTML = `<tr><td>å°ç¥¨æ€»é¢</td><td>${CUR}${stats.mSales.toFixed(1)}</td></tr><tr><td>ç°é‡‘å®æ”¶</td><td>${CUR}${stats.mCash.toFixed(1)}</td></tr><tr><td>åˆ·å¡(POS)</td><td>${CUR}${stats.mPos.toFixed(1)}</td></tr><tr style="color:orange"><td>è¯¯å·®å€¼</td><td>${CUR}${stats.mDiff.toFixed(1)}</td></tr><tr style="font-weight:bold; border-top:2px solid #eee;"><td>æ¨¡å—ç›ˆäº</td><td style="color:${currentProfit>=0?'green':'red'}">${CUR}${currentProfit.toFixed(1)}</td></tr>`;
        document.getElementById('itemTbody').innerHTML = Object.entries(itemAgg)
            .sort((a, b) => b[1] - a[1]) 
            .map(([k,v])=>`<tr><td>${k}</td><td>${CUR}${v.toFixed(1)}</td></tr>`)
            .join('');

        let sortedCats = db.catOrder.map(p => {
            let pA = 0;
            Object.entries(expAgg).forEach(([k, v]) => { if (k.startsWith(p + ':')) pA += v; });
            return { name: p, total: pA };
        })
        .filter(item => item.total > 0)
        .sort((a, b) => b.total - a.total);

        let eH = ""; 
        sortedCats.forEach(cat => {
            const p = cat.name;
            const pA = cat.total;
            eH += `<tr style="background:#f9f9f9;font-weight:bold"><td>${p}</td><td>${CUR}${pA.toFixed(1)}</td><td>${(pA/(stats.mExp||1)*100).toFixed(1)}%</td></tr>`; 
            
            let subList = [];
            Object.entries(expAgg).forEach(([k, v]) => {
                if (k.startsWith(p + ':')) {
                    subList.push({ name: k.split(':')[1], val: v });
                }
            });

            subList.sort((a, b) => b.val - a.val);

            subList.forEach(item => {
                eH += `<tr class="sub-row"><td>â”” ${item.name}</td><td>${CUR}${item.val.toFixed(1)}</td><td></td></tr>`;
            });
        });
        document.getElementById('expTbody').innerHTML = eH; 
        
        let staffRows = "", totalSal = 0, totalLoan = 0;
        Object.entries(staffSummary).forEach(([name, val]) => {
            totalSal += val.sal; totalLoan += val.loan;
            staffRows += `<tr><td>${name}</td><td>${CUR}${val.sal.toFixed(1)}</td><td>${CUR}${val.loan.toFixed(1)}</td><td>${CUR}${(val.sal-val.loan).toFixed(1)}</td></tr>`;
        });
        staffRows = `<tr style="background:#fff9c4; font-weight:bold; border-bottom: 2px solid #fb8c00;"><td>ğŸŒŸ å…¨å‘˜åˆè®¡</td><td>${CUR}${totalSal.toFixed(1)}</td><td>${CUR}${totalLoan.toFixed(1)}</td><td style="color:#e65100">${CUR}${(totalSal-totalLoan).toFixed(1)}</td></tr>` + staffRows;
        document.getElementById('staffTbody').innerHTML = staffRows;

        const filtered = db.recs.filter(r => {
            const inDate = (r.date >= fS && r.date <= fE);
            const isDebtModule = (r.type === 'buy' || r.type === 'pay');
            const inKey = !fK || (isDebtModule ? (r.sup && r.sup.toLowerCase() === fK) : JSON.stringify(r).toLowerCase().includes(fK));
            
            let inMode = (mode === 'shift' && r.type === 'day-sum') || (mode === 'debt' && isDebtModule) || (mode === 'staff' && (r.type === 'salary' || r.type === 'loan'));
            return inDate && inKey && inMode;
        });

        document.getElementById('tbody').innerHTML = filtered.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).map(r => {
            let typeLabel = {'day-sum':'æ”¶æ”¯','buy':'æŒ‚è´¦','pay':'è¿˜æ¬¾','salary':'å·¥èµ„','loan':'å€Ÿæ¬¾'}[r.type];
            let detailHtml = "";
            if (r.type === 'day-sum') {
                detailHtml = `<span class="txt-rev-line" style="color:#1a237e;">æ”¶: è¥æ”¶${CUR}${r.totalSales.toFixed(1)} | ç°é‡‘${CUR}${r.cash.toFixed(1)} | POS${CUR}${r.pos.toFixed(1)} ${r.diff ? `<small style="color:#ffa000; font-weight:normal;"> (è¯¯:${r.diff.toFixed(1)})</small>` : ''}</span>`;
                if(r.expDetails && r.expDetails.length > 0) detailHtml += `<span class="txt-exp-line">æ”¯: ${r.expDetails.map(ed => `${ed.cat.split(':')[1]}${CUR}${ed.amt}`).join(', ')}</span>`;
            } else if (r.type === 'buy') {
                detailHtml = `[${r.sup}] ${r.itemDetails ? r.itemDetails.map(i=>i.name+CUR+i.amt).join(',') : 'é‡‡è´­æŒ‚è´¦'}`;
            } else if (r.type === 'pay') {
                detailHtml = `[${r.sup || 'ä¾›åº”å•†'}] è¿˜æ¬¾æ”¯ä»˜`;
            } else {
                detailHtml = `<b>${r.staff}</b> ${r.notes ? `(${r.notes})` : ''}`;
            }
            if(r.bill) detailHtml += ` <small style="color:#999">(å•:${r.bill})</small>`;

            return `<tr>
                <td>${r.date}</td><td>${typeLabel}</td><td style="padding:4px 8px">${detailHtml}</td>
                <td style="font-weight:bold">${CUR}${(r.type==='day-sum' ? (r.cash + r.pos) : (r.amt||0)).toFixed(1)}</td>             
                <td class="no-print">${r.img?`<button onclick="showImg('${r.img}')" style="padding:2px 5px">å›¾</button>`:'-'}</td>
                <td class="no-print"><button onclick="delRec(${r.id})" style="background:#ffcdd2;color:#b71c1c;padding:2px 5px">åˆ </button></td>
            </tr>`;
        }).join('');
        renderCalendar(document.getElementById('cal-picker').value, calData);
    }

    function renderCalendar(monStr, data) {
        const cal = document.getElementById('calendar'); 
        cal.innerHTML = "";
        const [y, m] = monStr.split('-').map(Number); 
        
        const firstDay = new Date(y, m-1, 1).getDay(); 
        const daysInMonth = new Date(y, m, 0).getDate();
        
        for(let i=0; i<firstDay; i++) {
            cal.innerHTML += '<div></div>';
        }
        
        for(let d=1; d<=daysInMonth; d++) {
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const val = data[ds] || 0;
            
            cal.innerHTML += `
                <div class="cal-day ${val?'has-data':''}" onclick="document.getElementById('f-start').value='${ds}';document.getElementById('f-end').value='${ds}';render();">
                    <b>${d}</b><br>
                    <small style="color:#666">${val?CUR+val.toFixed(0):''}</small>
                </div>`;
        }
    }
    
    async function getImg(fileInput) { 
        if(capturedImgData) return capturedImgData; 
        const file = fileInput.files[0]; 
        if(!file) return null; 
        return new Promise((res) => { 
            const reader = new FileReader(); 
            reader.onload = () => res(reader.result); 
            reader.readAsDataURL(file); 
        }); 
    }
    
    function showImg(src) { 
        document.getElementById('modal-content').src = src; 
        document.getElementById('img-modal').style.display='flex'; 
    }
    
    async function delRec(id) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½åˆ é™¤ï¼');
            return;
        }
        if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { 
            db.recs = db.recs.filter(r=>r.id!==id); 
            await updateDB(db); 
        } 
    }
    
    async function delSet(key, i) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½åˆ é™¤ï¼');
            return;
        }
        const k = key==='sup'?'sups':'staffs'; 
        db[k].splice(i,1); 
        await updateDB(db); 
    }
    
    async function addSetting(key) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½æ·»åŠ ï¼');
            return;
        }
        const v = prompt("è¾“å…¥åç§°:"); 
        if(v) { 
            const k = key==='sup'?'sups':'staffs'; 
            db[k].push(v); 
            await updateDB(db); 
        } 
    }

    async function addParentCat() { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½æ·»åŠ ï¼');
            return;
        }
        const v = prompt("è¾“å…¥å¤§ç±»åç§°:"); 
        if(v && !db.catOrder.includes(v)) { 
            db.catOrder.push(v); 
            db.cats[v] = []; 
            await updateDB(db); 
        } 
    }

    async function renameParentCat(oldName, newName) {
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿®æ”¹ï¼');
            render();
            return;
        }
        newName = newName.trim();
        if (!newName || oldName === newName) { render(); return; }
        if (db.catOrder.includes(newName)) { alert("è¯¥åç§°å·²å­˜åœ¨"); render(); return; }
        db.cats[newName] = db.cats[oldName];
        delete db.cats[oldName];
        const idx = db.catOrder.indexOf(oldName);
        if (idx !== -1) db.catOrder[idx] = newName;
        db.recs.forEach(r => {
            if (r.expDetails) {
                r.expDetails.forEach(ed => {
                    if (ed.cat && ed.cat.startsWith(oldName + ':')) {
                        ed.cat = ed.cat.replace(oldName + ':', newName + ':');
                    }
                });
            }
        });
        await updateDB(db);
    }

    async function renameChildCat(p, oldC, newC) {
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿®æ”¹ï¼');
            render();
            return;
        }
        newC = newC.trim();
        if (!newC || oldC === newC) { render(); return; }
        if (db.cats[p].includes(newC)) { alert("è¯¥åç§°å·²å­˜åœ¨"); render(); return; }
        const idx = db.cats[p].indexOf(oldC);
        if (idx !== -1) db.cats[p][idx] = newC;
        const oldFull = p + ":" + oldC;
        const newFull = p + ":" + newC;
        db.recs.forEach(r => {
            if (r.expDetails) {
                r.expDetails.forEach(ed => {
                    if (ed.cat === oldFull) ed.cat = newFull;
                });
            }
        });
        await updateDB(db);
    }

    async function delParentCat(p) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½åˆ é™¤ï¼');
            return;
        }
        if(confirm(`ç¡®å®šåˆ é™¤å¤§ç±» ${p} åŠå…¶æ‰€æœ‰å­ç±»ï¼Ÿ`)) { 
            db.catOrder = db.catOrder.filter(x => x !== p); 
            delete db.cats[p]; 
            await updateDB(db); 
        } 
    }

    async function addChildCat(p) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½æ·»åŠ ï¼');
            return;
        }
        const v = prompt(`åœ¨å¤§ç±» [${p}] ä¸‹æ–°å¢å­ç±»:`); 
        if(v) { 
            if(!db.cats[p]) db.cats[p]=[]; 
            db.cats[p].push(v); 
            await updateDB(db); 
        } 
    }

    async function delChildCat(p, ci) { 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½åˆ é™¤ï¼');
            return;
        }
        db.cats[p].splice(ci,1); 
        await updateDB(db); 
    }
    
    function moveParent(i, dir) {
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ç§»åŠ¨ï¼');
            return;
        }
        const target = i + dir;
        if(target < 0 || target >= db.catOrder.length) return;
        const temp = db.catOrder[i];
        db.catOrder[i] = db.catOrder[target];
        db.catOrder[target] = temp;
        updateDB(db);
    }
    
    function moveChild(p, i, dir) {
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ç§»åŠ¨ï¼');
            return;
        }
        const target = i + dir;
        if(target < 0 || target >= db.cats[p].length) return;
        const temp = db.cats[p][i];
        db.cats[p][i] = db.cats[p][target];
        db.cats[p][target] = temp;
        updateDB(db);
    }

    function calcShift() {
        const t = parseFloat(document.getElementById('in-total-sales').value)||0, 
              p = parseFloat(document.getElementById('in-pos-sales').value)||0, 
              df = parseFloat(document.getElementById('in-diff').value)||0;
        let g = 0; 
        document.querySelectorAll('#exp-rows .exp-amt').forEach(input => g += (parseFloat(input.value)||0));
        document.getElementById('shift-preview').innerHTML = `ç°é‡‘å®æ”¶è®¡ç®—: ${t}(æ€») - ${g}(æ”¯) - ${p}(å¡) + ${df}(è¯¯) = <b>${CUR}${(t-g-p+df).toFixed(1)}</b>`;
    }

    document.getElementById('shiftForm').onsubmit = async (e) => {
        e.preventDefault(); 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿å­˜ï¼');
            return;
        }
        const t = parseFloat(document.getElementById('in-total-sales').value)||0, 
              p = parseFloat(document.getElementById('in-pos-sales').value)||0, 
              df = parseFloat(document.getElementById('in-diff').value)||0;
        let ed = [], g = 0; 
        document.querySelectorAll('#exp-rows .batch-row').forEach(row => { 
            const cat = row.querySelector('.exp-c-cat').value, 
                  a = parseFloat(row.querySelector('.exp-amt').value)||0; 
            if(a>0) { ed.push({cat:cat, amt:a}); g+=a; } 
        });
        const rec = { 
            id:Date.now(), 
            date:document.getElementById('in-date').value, 
            type:'day-sum', 
            totalSales:t, 
            pos:p, 
            diff:df, 
            cash:(t-g-p+df), 
            expDetails:ed 
        };
        rec.img = await getImg(document.getElementById('in-file-shift')); 
        forceSave(rec); 
        document.getElementById('shiftForm').reset(); 
        resetInputsToToday(); 
        document.getElementById('exp-rows').innerHTML = ""; 
        addExpRow();
    };

    document.getElementById('debtForm').onsubmit = async (e) => {
        e.preventDefault(); 
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿å­˜ï¼');
            return;
        }
        let items = []; 
        document.querySelectorAll('#debt-tag-rows .batch-row').forEach(row => { 
            const name = row.querySelector('input').value, 
                  amt = parseFloat(row.querySelectorAll('input')[1].value)||0; 
            if(name && amt > 0) items.push({name, amt}); 
        });
        const rec = { 
            id: Date.now(), 
            date: document.getElementById('debt-date').value, 
            type: document.getElementById('in-action').value, 
            sup: document.getElementById('sel-sup').value, 
            bill: document.getElementById('in-bill').value, 
            amt: parseFloat(document.getElementById('debt-amt').value) || 0, 
            itemDetails: items 
        };
        rec.img = await getImg(document.getElementById('in-file-debt')); 
        forceSave(rec); 
        document.getElementById('debtForm').reset(); 
        document.getElementById('debt-tag-rows').innerHTML = ""; 
        resetInputsToToday();
    };

    document.getElementById('staffForm').onsubmit = async (e) => {
        e.preventDefault();
        if (!isUnlocked) {
            alert('ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”åæ‰èƒ½ä¿å­˜ï¼');
            return;
        }
        const rec = { 
            id: Date.now(), 
            date: document.getElementById('staff-date').value, 
            type: document.getElementById('staff-type').value, 
            staff: document.getElementById('sel-staff').value, 
            amt: parseFloat(document.getElementById('staff-amt').value) || 0, 
            notes: document.getElementById('staff-notes').value 
        };
        rec.img = await getImg(document.getElementById('in-file-staff'));
        forceSave(rec);
        document.getElementById('staffForm').reset();
        resetInputsToToday();
    };

    function addExpRow() {
        const div = document.createElement('div');
        div.className = 'batch-row';
        let parentOptions = ""; 
        db.catOrder.forEach(p => { parentOptions += `<option value="${p}">${p}</option>`; });

        div.innerHTML = `
            <select class="exp-p-cat" onchange="updateChildSelect(this)" style="flex:1">${parentOptions}</select>
            <select class="exp-c-cat" style="flex:1"></select>
            <input type="number" class="exp-amt" step="0.01" placeholder="é‡‘é¢" oninput="calcShift()" style="flex:1">
            <b onclick="this.parentElement.remove();calcShift()" style="color:red; cursor:pointer; padding:0 5px">Ã—</b>
        `;
        document.getElementById('exp-rows').appendChild(div);
        updateChildSelect(div.querySelector('.exp-p-cat'));
    }

    function updateChildSelect(pSelect) {
        const pName = pSelect.value;
        const cSelect = pSelect.parentElement.querySelector('.exp-c-cat');
        cSelect.innerHTML = ''; 
        if (pName && db.cats[pName]) {
            db.cats[pName].forEach(c => {
                const opt = document.createElement('option');
                opt.value = `${pName}:${c}`;
                opt.textContent = c;
                cSelect.appendChild(opt);
            });
        }
    }

    function toggleDebtHelper() {
        const act = document.getElementById('in-action').value;
        document.getElementById('debt-helper').style.display = (act === 'buy' ? 'block' : 'none');
    }

    function addDebtTagRow() {
        const div = document.createElement('div');
        div.className = 'batch-row';
        div.innerHTML = `
            <input type="text" placeholder="è´§å“" style="flex:2">
            <input type="number" step="0.01" placeholder="é‡‘é¢" style="flex:1">
            <b onclick="this.parentElement.remove()" style="color:red; cursor:pointer; padding:0 10px; font-size:18px;">Ã—</b>
        `;
        document.getElementById('debt-tag-rows').appendChild(div);
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db.recs);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Financial_Data");
        XLSX.writeFile(wb, `Bluefield_Finance_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

        function importBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = JSON.parse(readerEvent.target.result);
                    if (content.recs && content.cats) {
                        if (confirm("âš ï¸ å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼ç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ")) {
                            db = content;
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                            saveToCloud();
                            location.reload();
                        }
                    } else {
                        alert("âŒ é”™è¯¯ï¼šå¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
                    }
                } catch (err) {
                    alert("âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåã€‚");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

// ==================== æ·»åŠ ç¼ºå¤±çš„å‡½æ•° ====================

// ä¿å­˜åˆ°äº‘ç«¯
async function saveToCloud() {
    if (!firebaseLoaded || !firestore || syncInProgress) return false;
    
    try {
        syncInProgress = true;
        await firestore.collection('financeData').doc('mainData').set({
            ...db,
            lastSync: new Date().toISOString()
        });
        document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âœ… å·²åŒæ­¥ ' + new Date().toLocaleTimeString();
        return true;
    } catch (error) {
        console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
        document.getElementById('cloud-status').innerHTML = 'â˜ï¸ äº‘ç«¯åŒæ­¥: âš ï¸ åŒæ­¥å¤±è´¥';
        return false;
    } finally {
        syncInProgress = false;
    }
}

// æ›´æ–°æ•°æ®åº“
async function updateDB(newDB) {
    db = newDB;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    await saveToCloud();
    render();
}

// ä»æœ¬åœ°åŠ è½½æ•°æ®ï¼ˆå¤‡ç”¨ï¼‰
function loadFromLocal() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            let parsed = JSON.parse(saved);
            if (parsed) {
                db = parsed;
                if (!db.catOrder) db.catOrder = Object.keys(db.cats || {});
            }
        } catch (e) {
            console.error('è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', e);
        }
    }
    render();
}
</script>
</body>
</html>





