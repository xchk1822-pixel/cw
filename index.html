<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bluefield è´¢åŠ¡ç³»ç»Ÿ - å®Œæ•´ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #3f51b5; --bg: #f5f7fa; --success: #43a047; --danger: #e53935; --warning: #ffa000; --info: #00acc1; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .header { background: var(--primary); color: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { padding: 12px; border-radius: 6px; color: white; text-align: center; }
        .bg-total { background: #546e7a; } .bg-rev { background: var(--success); } .bg-exp { background: var(--danger); } .bg-profit { background: #fb8c00; } .bg-debt { background: var(--primary); }
        .val-big { font-size: 18px; font-weight: bold; margin: 5px 0; }
        input, select, button { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; font-size: 13px; }
        th { background: #f8f9fa; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 10px; }
        .cal-day { border: 1px solid #eee; padding: 5px 0; text-align: center; font-size: 11px; cursor: pointer; background: #fff; }
        .cal-day.has-data { background: #e8f5e9; }
        .tag-box { border: 1px solid #eee; padding: 10px; max-height: 200px; overflow-y: auto; background: #fafafa; }
        .tag { display: flex; justify-content: space-between; align-items: center; background: white; padding: 4px 8px; margin-bottom: 4px; border: 1px solid #eee; font-size: 12px; }
        .move-btn { cursor: pointer; color: var(--primary); font-weight: bold; padding: 0 5px; }
        #img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center; }
        .capture-area { border: 2px dashed #ccc; padding: 10px; margin: 10px 0; background: #f0f0f0; }
        video { width: 100%; border-radius: 4px; }
        @media print { .no-print { display: none !important; } .main-layout { display: block; } .box { box-shadow: none; border: 1px solid #eee; } }
    </style>
</head>
<body onload="init()">
    <div id="img-modal" onclick="this.style.display='none'"><img id="modal-content" style="max-width:90%; max-height:90%;"></div>
    <div class="header no-print">
        <h2 style="margin:0;">Bluefield é¤å…è´¢åŠ¡ç³»ç»Ÿ</h2>
        <div id="clock"></div>
    </div>
    <div class="grid-5 no-print">
        <div class="card bg-total">ç´¯è®¡æ€»é¢<div class="val-big" id="h-all-rev">0</div></div>
        <div class="card bg-rev">åŒºé—´è¥æ”¶<div class="val-big" id="h-mon-rev">0</div><small id="h-pos-info"></small></div>
        <div class="card bg-exp">åŒºé—´æ”¯å‡º<div class="val-big" id="h-mon-exp">0</div></div>
        <div class="card bg-profit">ç›ˆäº(å«è¯¯å·®)<div class="val-big" id="h-profit">0</div></div>
        <div class="card bg-debt">åº”ä»˜æ¬ æ¬¾<div class="val-big" id="h-debt">0</div></div>
    </div>
    <div class="main-layout">
        <aside class="no-print">
            <div class="box">
                <b>ğŸ—“ï¸ æœˆåº¦æ—¥å†</b>
                <input type="month" id="cal-picker" onchange="render()">
                <div id="calendar" class="calendar-grid"></div>
            </div>
            <div class="box">
                <select id="main-mode" onchange="switchForm()">
                    <option value="shift">äº¤ç­ç»“è½¬</option>
                    <option value="debt">ä¾›åº”å•†è´¦ç›®</option>
                    <option value="staff">å‘˜å·¥è–ªèµ„</option>
                </select>
                <div id="capture-container" class="capture-area" style="display:none;">
                    <video id="video" autoplay muted></video>
                    <button onclick="takeScreenshot()" style="background:var(--danger)">ç¡®è®¤æˆªå±</button>
                </div>
                <form id="shiftForm" onsubmit="saveShift(event)">
                    <input type="date" id="in-date" required>
                    <input type="number" id="in-total-sales" step="0.01" placeholder="VENTAS æ€»é¢" required oninput="calcShift()">
                    <input type="number" id="in-pos-sales" step="0.01" placeholder="POS åˆ·å¡" required oninput="calcShift()">
                    <input type="number" id="in-diff" step="0.01" placeholder="è¯¯å·® Dif" oninput="calcShift()">
                    <div id="exp-rows"></div>
                    <button type="button" onclick="addExpRow()" style="background:#90a4ae">+ å¢åŠ æ”¯å‡º</button>
                    <div id="shift-preview" style="background:#fff3e0; padding:8px; font-size:12px; margin:5px 0;"></div>
                    <button type="button" onclick="startCapture()" style="background:var(--info)">ğŸ–¥ï¸ æˆªå›¾</button>
                    <button type="submit" style="background:var(--success)">ä¿å­˜äº¤ç­</button>
                </form>
                <form id="debtForm" style="display:none;" onsubmit="saveDebt(event)">
                    <input type="date" id="debt-date">
                    <select id="sel-sup"></select>
                    <input type="text" id="in-bill" placeholder="å•å·" required>
                    <select id="in-action"><option value="buy">æŒ‚è´¦é‡‡è´­</option><option value="pay">è¿˜æ¬¾æ”¯ä»˜</option></select>
                    <input type="number" id="debt-amt" step="0.01" placeholder="é‡‘é¢" required>
                    <button type="submit">ä¿å­˜å•æ®</button>
                </form>
                <form id="staffForm" style="display:none;" onsubmit="saveStaff(event)">
                    <input type="date" id="staff-date">
                    <select id="sel-staff"></select>
                    <select id="staff-type"><option value="salary">å‘å·¥èµ„</option><option value="loan">å€Ÿæ¬¾</option></select>
                    <input type="number" id="staff-amt" step="0.01" placeholder="é‡‘é¢" required>
                    <button type="submit" style="background:var(--warning)">å½•å…¥</button>
                </form>
            </div>
            <div class="box no-print">
                <b>âš™ï¸ åˆ†ç±»/æ’åº</b>
                <div id="list-cat" class="tag-box"></div>
                <button onclick="addParentCat()" style="font-size:11px;">+ å¤§ç±»</button>
                <button onclick="exportBackup()" style="background:#673ab7; font-size:11px; margin-top:10px;">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
                <button onclick="importBackup()" style="background:#607d8b; font-size:11px;">ğŸ“¥ å¯¼å…¥å¤‡ä»½</button>
            </div>
        </aside>
        <main>
            <div class="box no-print" style="display:flex; gap:10px;">
                <input type="date" id="f-start" onchange="render()">
                <input type="date" id="f-end" onchange="render()">
                <input type="text" id="f-key" placeholder="æœç´¢..." oninput="render()">
            </div>
            <div id="view-shift" class="box">
                <b>ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</b>
                <div style="display:flex; gap:15px;">
                    <table style="flex:1"><thead><tr><th>è¥æ”¶ç±»å‹</th><th>é‡‘é¢</th></tr></thead><tbody id="revTbody"></tbody></table>
                    <table style="flex:1.5"><thead><tr><th>æ”¯å‡ºæ±‡æ€»</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead><tbody id="expTbody"></tbody></table>
                </div>
            </div>
            <div id="view-debt" class="box" style="display:none;"><b>ğŸš› ä¾›åº”å•†å¯¹è´¦</b><table><thead><tr><th>ä¾›åº”å•†</th><th>å•å·</th><th>æ¬ æ¬¾</th><th>å·²ä»˜</th><th>ä½™é¢</th></tr></thead><tbody id="billTbody"></tbody></table></div>
            <div id="view-staff" class="box" style="display:none;"><b>ğŸ‘¤ å‘˜å·¥ç»Ÿè®¡</b><table><thead><tr><th>å§“å</th><th>å·¥èµ„</th><th>å€Ÿæ¬¾</th><th>å·®é¢</th></tr></thead><tbody id="staffTbody"></tbody></table></div>
            <div class="box">
                <b>ğŸ“‘ æ˜ç»†æµæ°´</b>
                <table><thead><tr><th>æ—¥æœŸ</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th><th class="no-print">æ“ä½œ</th></tr></thead><tbody id="tbody"></tbody></table>
            </div>
        </main>
    </div>
<script>
    const STORAGE_KEY = "BF_DB_V2026";
    let db = { recs: [], cats: {"æ‚è´¹":["å…¶ä»–"]}, sups: ['é»˜è®¤'], staffs: ['é»˜è®¤'], catOrder: ["æ‚è´¹"] };
    let capturedImg = null;

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) try { db = JSON.parse(saved); } catch(e){}
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('f-start').value = today.substring(0,8)+'01';
        document.getElementById('f-end').value = today;
        document.getElementById('cal-picker').value = today.substring(0,7);
        render();
        setInterval(()=> { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
    }

    function render() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        const fS = document.getElementById('f-start').value, fE = document.getElementById('f-end').value, fK = document.getElementById('f-key').value.toLowerCase();
        const mode = document.getElementById('main-mode').value;
        
        // æ¸²æŸ“é…ç½®
        let catH = "";
        db.catOrder.forEach((p, pi) => {
            catH += `<div style="font-weight:bold; background:#eee; padding:2px 5px; margin-top:5px; display:flex; justify-content:space-between;">
                <span contenteditable="true" onblur="renameParentCat('${p}',this.innerText)">${p}</span>
                <span><small onclick="addChildCat('${p}')" style="cursor:pointer;color:green">[+]</small> 
                <span class="move-btn" onclick="moveParent(${pi},-1)">â†‘</span><span class="move-btn" onclick="moveParent(${pi},1)">â†“</span></span></div>`;
            (db.cats[p]||[]).forEach((c, ci) => {
                catH += `<div class="tag"><span contenteditable="true" onblur="renameChildCat('${p}','${c}',this.innerText)">${c}</span><b style="color:red;cursor:pointer" onclick="delChildCat('${p}',${ci})">Ã—</b></div>`;
            });
        });
        document.getElementById('list-cat').innerHTML = catH;
        document.getElementById('sel-sup').innerHTML = db.sups.map(s=>`<option>${s}</option>`).join('');
        document.getElementById('sel-staff').innerHTML = db.staffs.map(s=>`<option>${s}</option>`).join('');

        // è®¡ç®—é€»è¾‘
        let stats = { mCash:0, mPos:0, mExp:0, mSales:0, aSales:0, tDebt:0, mDiff:0 };
        let expAgg = {}, staffSum = {}, billAgg = {}, calData = {};
        db.staffs.forEach(s => staffSum[s] = {sal:0, loan:0});

        db.recs.forEach(r => {
            if(r.type==='buy') stats.tDebt += r.amt; if(r.type==='pay') stats.tDebt -= r.amt;
            if(r.type==='day-sum') stats.aSales += r.totalSales;
            if(r.date >= fS && r.date <= fE) {
                if(r.type==='day-sum') {
                    stats.mSales += r.totalSales; stats.mPos += r.pos; stats.mDiff += (r.diff||0);
                    r.expDetails.forEach(ed => { stats.mExp += ed.amt; expAgg[ed.cat] = (expAgg[ed.cat]||0) + ed.amt; });
                } else if(r.type==='pay') { stats.mExp += r.amt; expAgg['è¿˜æ¬¾'] = (expAgg['è¿˜æ¬¾']||0) + r.amt; }
                if(r.type==='buy'||r.type==='pay') {
                    const k = `${r.sup}_${r.bill}`; if(!billAgg[k]) billAgg[k]={sup:r.sup, bill:r.bill, buy:0, pay:0};
                    r.type==='buy' ? billAgg[k].buy+=r.amt : billAgg[k].pay+=r.amt;
                }
                if(r.staff) { if(r.type==='salary') staffSum[r.staff].sal += r.amt; if(r.type==='loan') staffSum[r.staff].loan += r.amt; }
            }
            if(r.type==='day-sum' && r.date.startsWith(document.getElementById('cal-picker').value)) calData[r.date] = (calData[r.date]||0) + r.totalSales;
        });
        stats.mCash = stats.mSales - stats.mPos - (stats.mExp - (expAgg['è¿˜æ¬¾']||0)) + stats.mDiff;

        // æ›´æ–° UI
        document.getElementById('h-all-rev').innerText = stats.aSales.toFixed(0);
        document.getElementById('h-mon-rev').innerText = stats.mSales.toFixed(1);
        document.getElementById('h-pos-info').innerText = `ç°:${stats.mCash.toFixed(1)} PO:${stats.mPos.toFixed(1)}`;
        document.getElementById('h-mon-exp').innerText = stats.mExp.toFixed(1);
        document.getElementById('h-profit').innerText = (stats.mSales - stats.mExp + stats.mDiff).toFixed(1);
        document.getElementById('h-debt').innerText = stats.tDebt.toFixed(1);

        document.getElementById('revTbody').innerHTML = `<tr><td>æ€»é”€å”®</td><td>${stats.mSales}</td></tr><tr><td>POS</td><td>${stats.mPos}</td></tr><tr><td>ç°é‡‘</td><td>${stats.mCash.toFixed(1)}</td></tr>`;
        document.getElementById('expTbody').innerHTML = Object.entries(expAgg).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td><td>${(v/(stats.mExp||1)*100).toFixed(1)}%</td></tr>`).join('');
        document.getElementById('billTbody').innerHTML = Object.values(billAgg).map(b=>`<tr><td>${b.sup}</td><td>${b.bill}</td><td>${b.buy}</td><td>${b.pay}</td><td>${b.buy-b.pay}</td></tr>`).join('');
        document.getElementById('staffTbody').innerHTML = Object.entries(staffSum).map(([n,v])=>`<tr><td>${n}</td><td>${v.sal}</td><td>${v.loan}</td><td>${v.sal-v.loan}</td></tr>`).join('');

        const filtered = db.recs.filter(r => (r.date >= fS && r.date <= fE) && (!fK || JSON.stringify(r).toLowerCase().includes(fK)));
        document.getElementById('tbody').innerHTML = filtered.sort((a,b)=>b.date.localeCompare(a.date)).map(r => `
            <tr><td>${r.date}</td><td>${r.type==='day-sum'?'è¥ä¸šæ±‡æ€»':(r.sup||r.staff)}</td><td>${(r.amt||r.totalSales)}</td>
            <td class="no-print">${r.img?`<button onclick="showImg('${r.img}')">å›¾</button>`:''}<button onclick="delRec(${r.id})">åˆ </button></td></tr>`).join('');
        
        renderCal(calData);
    }

    function addExpRow() {
        const d = document.createElement('div'); d.style="display:flex;gap:2px";
        let o = ""; db.catOrder.forEach(p=>(db.cats[p]||[]).forEach(c=>o+=`<option value="${p}:${c}">${p}-${c}</option>`));
        d.innerHTML = `<select class="e-c">${o}</select><input type="number" class="e-a" placeholder="é‡‘é¢" oninput="calcShift()">`;
        document.getElementById('exp-rows').appendChild(d);
    }
    function calcShift() {
        const t = parseFloat(document.getElementById('in-total-sales').value)||0, p = parseFloat(document.getElementById('in-pos-sales').value)||0, df = parseFloat(document.getElementById('in-diff').value)||0;
        let e = 0; document.querySelectorAll('.e-a').forEach(i=>e+=parseFloat(i.value)||0);
        document.getElementById('shift-preview').innerText = `ç°é‡‘é¢„ä¼°: ${(t-p-e+df).toFixed(1)}`;
    }
    function saveShift(e) {
        e.preventDefault();
        const r = { id:Date.now(), type:'day-sum', date:document.getElementById('in-date').value, totalSales:parseFloat(document.getElementById('in-total-sales').value), pos:parseFloat(document.getElementById('in-pos-sales').value), diff:parseFloat(document.getElementById('in-diff').value)||0, expDetails:[], img:capturedImg };
        document.querySelectorAll('#exp-rows div').forEach(row=> { const a=parseFloat(row.querySelector('.e-a').value); if(a) r.expDetails.push({cat:row.querySelector('.e-c').value, amt:a}); });
        db.recs.push(r); e.target.reset(); document.getElementById('exp-rows').innerHTML=""; render();
    }
    function saveDebt(e) { e.preventDefault(); db.recs.push({id:Date.now(), type:document.getElementById('in-action').value, date:document.getElementById('debt-date').value, sup:document.getElementById('sel-sup').value, bill:document.getElementById('in-bill').value, amt:parseFloat(document.getElementById('debt-amt').value)}); render(); }
    function saveStaff(e) { e.preventDefault(); db.recs.push({id:Date.now(), type:document.getElementById('staff-type').value, date:document.getElementById('staff-date').value, staff:document.getElementById('sel-staff').value, amt:parseFloat(document.getElementById('staff-amt').value)}); render(); }
    
    async function startCapture() { document.getElementById('capture-container').style.display='block'; const s = await navigator.mediaDevices.getDisplayMedia({video:true}); document.getElementById('video').srcObject=s; }
    function takeScreenshot() { const v=document.getElementById('video'), c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); capturedImg=c.toDataURL('image/jpeg',0.6); v.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById('capture-container').style.display='none'; alert("å·²æˆªå–"); }
    
    function renderCal(data) {
        const m = document.getElementById('cal-picker').value, [y,mo]=m.split('-').map(Number), f=new Date(y,mo-1,1).getDay(), d=new Date(y,mo,0).getDate();
        let h = ""; for(let i=0;i<f;i++) h+='<div></div>';
        for(let i=1;i<=d;i++) { const s=`${y}-${String(mo).padStart(2,'0')}-${String(i).padStart(2,'0')}`; h+=`<div class="cal-day ${data[s]?'has-data':''}" onclick="document.getElementById('f-start').value='${s}';document.getElementById('f-end').value='${s}';render();"><b>${i}</b><br>${data[s]?data[s].toFixed(0):''}</div>`; }
        document.getElementById('calendar').innerHTML=h;
    }

    function addParentCat() { const v=prompt("å¤§ç±»:"); if(v){db.catOrder.push(v); db.cats[v]=[]; render();}}
    function addChildCat(p) { const v=prompt("å­ç±»:"); if(v){db.cats[p].push(v); render();}}
    function renameParentCat(o,n) { if(n&&o!==n){db.cats[n]=db.cats[o]; delete db.cats[o]; db.catOrder=db.catOrder.map(x=>x===o?n:x); render();}}
    function renameChildCat(p,o,n) { if(n&&o!==n){db.cats[p]=db.cats[p].map(x=>x===o?n:x); render();}}
    function moveParent(i,d) { if(i+d>=0&&i+d<db.catOrder.length){[db.catOrder[i],db.catOrder[i+d]]=[db.catOrder[i+d],db.catOrder[i]]; render();}}
    function delChildCat(p,i) { if(confirm('åˆ ?')){db.cats[p].splice(i,1); render();}}
    function delRec(id) { if(confirm('åˆ ?')){db.recs=db.recs.filter(r=>r.id!==id); render();}}
    function showImg(s) { document.getElementById('modal-content').src=s; document.getElementById('img-modal').style.display='flex'; }
    function switchForm() { const m=document.getElementById('main-mode').value; ['shiftForm','debtForm','staffForm'].forEach(f=>document.getElementById(f).style.display=f.startsWith(m)?'block':'none'); render(); }
    function exportBackup() { const b=new Blob([JSON.stringify(db)],{type:"application/json"}), a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Backup.json"; a.click(); }
    function importBackup() { const i=document.createElement('input'); i.type='file'; i.onchange=e=>{const r=new FileReader(); r.onload=f=>{db=JSON.parse(f.target.result); render();}; r.readAsText(e.target.files[0]);}; i.click(); }
</script>
</body>
</html>
