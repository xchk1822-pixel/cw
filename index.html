<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #3f51b5; --bg: #f5f7fa; --success: #43a047; --danger: #e53935; --warning: #ffa000; --info: #00acc1; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .box { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .header { background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 20px; }
        #clock { position: absolute; right: 20px; font-size: 14px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 15px; }
        .card { padding: 15px; border-radius: 6px; color: white; text-align: center; }
        .bg-rev { background: var(--success); } .bg-total { background: #546e7a; } .bg-exp { background: var(--danger); } .bg-profit { background: #fb8c00; } .bg-debt { background: #1e88e5; }
        .val-big { font-size: 20px; font-weight: bold; margin: 5px 0; }
        .val-small { font-size: 11px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 8px 10px; text-align: left; font-size: 13px; word-break: break-all; }
        th { background: #f8f9fa; color: #666; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .cal-day { border: 1px solid #eee; padding: 5px 2px; text-align: center; border-radius: 4px; font-size: 11px; background: #fff; min-height: 40px;}
        .cal-day.has-data { background: #e8f5e9; border-color: #c8e6c9; }
        .tag-box { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .tag { background: #eceff1; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 5px; justify-content: space-between;}
        .tag b { color: #e53935; cursor: pointer; font-size: 16px; }
        .move-btn { cursor: pointer; color: var(--primary); font-weight: bold; padding: 0 3px; font-size: 14px; }
        .batch-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
        .search-bar { background: #e8eaf6; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        #img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
        #img-modal img { max-width:90%; max-height:90%; border:3px solid white; }
        .sub-row { background: #fafafa; font-size: 12px; color: #777; }
        .capture-area { border: 2px dashed #ccc; padding: 10px; margin: 10px 0; display: none; text-align: center; }
        video { width: 100%; border-radius: 4px; background: #000; }
        .txt-rev-line { color: #2e7d32; font-weight: bold; border-bottom: 1px solid #f0f0f0; padding-bottom: 2px; margin-bottom: 2px; display: block; }
        .txt-exp-line { color: #d32f2f; font-size: 12px; display: block; }

        @media print {
            .no-print, aside, .header, .grid-5, .search-bar, .tag-box, button { display: none !important; }
            body { background: white; padding: 0; margin: 0; font-size: 10px; }
            .main-layout { display: block; }
            .box { box-shadow: none; border: 1px solid #000; margin-bottom: 10px; padding: 5px; border-radius: 0; }
            table { font-size: 10px; margin-top: 5px; }
            th, td { padding: 3px 5px; border: 1px solid #333; color: #000 !important; }
            .card, .bg-rev, .bg-total, .bg-exp, .bg-profit, .bg-debt { color: #000; background: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body onload="init()">

<div id="img-modal" onclick="this.style.display='none'"><img id="modal-content"></div>

<div class="header no-print">
    <h2 style="margin:0; font-size: 18px;">Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ</h2>
    <div id="clock"></div>
</div>

<div class="grid-5 no-print">
    <div class="card bg-total"><div>ç´¯è®¡è¥ä¸šæ€»é¢</div><div class="val-big" id="h-all-rev">C$ 0</div><div class="val-small">æ‰€æœ‰å•æ®æ€»å’Œ</div></div>
    <div class="card bg-rev"><div>åŒºé—´è¥æ”¶æ€»è®¡</div><div class="val-big" id="h-mon-rev">C$ 0</div><div class="val-small" id="h-pos-info">ç° C$ 0 | PO C$ 0</div></div>
    <div class="card bg-exp"><div>åŒºé—´ç´¯è®¡æ”¯å‡º</div><div class="val-big" id="h-mon-exp">C$ 0</div><div class="val-small">ä»…åŒ…å«è¥ä¸šæ”¯å‡ºåŠè¿˜æ¬¾</div></div>
    <div class="card bg-profit"><div>åŒºé—´æ€»ç›ˆäº</div><div class="val-big" id="h-profit">C$ 0</div><div class="val-small" style="color:#fff">æ€»é¢ - æ”¯å‡º + è¯¯å·®</div></div>
    <div class="card bg-debt"><div>åº”ä»˜æ€»æ¬ æ¬¾</div><div class="val-big" id="h-debt">C$ 0</div><div class="val-small" style="color:#ffeb3b">ä¾›åº”å•†å¾…ç»“æ€»é¢</div></div>
</div>

<div class="main-layout">
    <aside class="no-print">
        <div class="box">
            <b style="font-size:14px; color:var(--primary);">ğŸ—“ï¸ æœˆåº¦æ—¥å†</b>
            <input type="month" id="cal-picker" onchange="render()">
            <div class="calendar-grid" style="font-weight:bold; background:#e8eaf6; border-radius:4px; margin-bottom:5px; text-align:center;">
                <div style="color:var(--danger);">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div style="color:var(--danger);">å…­</div>
            </div>
            <div id="calendar" class="calendar-grid"></div>
        </div>
        
        <div class="box">
            <b style="font-size:14px;">æ•°æ®å½•å…¥ä¸æ¨¡å—åˆ‡æ¢</b>
            <select id="main-mode" onchange="switchForm()">
                <option value="shift">ğŸ® æ¯æ—¥äº¤ç­ç»“è½¬</option>
                <option value="debt">ğŸ“Š ä¾›åº”å•†è´¦ç›®</option>
                <option value="staff">ğŸ‘¤ å‘˜å·¥è–ªèµ„/å€Ÿæ¬¾</option>
            </select>
            <hr>
            <div id="capture-container" class="capture-area">
                <video id="video" autoplay muted></video>
                <button onclick="takeScreenshot()" style="background:var(--danger); margin-top:5px;">ç¡®è®¤æˆªå–</button>
                <button onclick="closeCapture()" style="background:#666;">å–æ¶ˆ</button>
            </div>

            <form id="shiftForm">
                <input type="date" id="in-date" required>
                <input type="number" id="in-total-sales" step="0.01" placeholder="VENTAS (å°ç¥¨æ€»é¢)" required oninput="calcShift()">
                <input type="number" id="in-pos-sales" step="0.01" placeholder="POS (åˆ·å¡)" required oninput="calcShift()">
                <input type="number" id="in-diff" step="0.01" placeholder="Dif (è¯¯å·®)" oninput="calcShift()">
                <div id="exp-rows"></div>
                <button type="button" onclick="addExpRow()" style="background:#90a4ae; font-size:11px;">+ å¢åŠ æ”¯å‡ºé¡¹</button>
                <div id="shift-preview" style="background:#fff3e0; padding:10px; border-radius:4px; font-size:12px;">ç­‰å¾…å½•å…¥...</div>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-shift" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-shift')" style="width:80px; background:var(--info);">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--success)">ä¿å­˜äº¤ç­</button>
            </form>

            <form id="debtForm" style="display:none;">
                <input type="date" id="debt-date">
                <select id="sel-sup"></select>
                <input type="text" id="in-bill" placeholder="å•å·" required>
                <select id="in-action" onchange="toggleDebtHelper()"><option value="buy">æŒ‚è´¦é‡‡è´­</option><option value="pay">è¿˜æ¬¾æ”¯ä»˜</option></select>
                <div id="debt-helper" style="background:#f5f5f5; padding:8px; border-radius:4px; margin:5px 0;">
                    <div id="debt-tag-rows"></div>
                    <button type="button" onclick="addDebtTagRow()" style="background:#ffb74d; font-size:10px;">+ å¢åŠ æ±‡æ€»é¡¹</button>
                </div>
                <input type="number" id="debt-amt" step="0.01" placeholder="æ€»é‡‘é¢" required>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-debt" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-debt')" style="width:80px; background:var(--info);">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--info)">ä¿å­˜å•æ®</button>
            </form>

            <form id="staffForm" style="display:none;">
                <input type="date" id="staff-date">
                <select id="sel-staff"></select>
                <select id="staff-type"><option value="salary">å‘æ”¾å·¥èµ„</option><option value="loan">å‘˜å·¥å€Ÿæ¬¾</option></select>
                <input type="number" id="staff-amt" step="0.01" placeholder="é‡‘é¢" required>
                <input type="text" id="staff-notes" placeholder="å¤‡æ³¨">
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-staff" accept="image/*">
                    <button type="button" onclick="startCapture('in-file-staff')" style="width:80px; background:var(--info);">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--warning); color:#333;">ä¿å­˜å‘˜å·¥è®°å½•</button>
            </form>
        </div>

        <div class="box no-print">
            <b style="font-size:13px;">âš™ï¸ é…ç½®ç®¡ç†</b>
            <div id="list-staff" class="tag-box"></div>
            <button onclick="addSetting('staff')" style="font-size:10px; background:#fb8c00;">+ å‘˜å·¥</button>
            <hr>
            <div id="list-sup" class="tag-box"></div>
            <button onclick="addSetting('sup')" style="font-size:10px; background:#607d8b;">+ ä¾›åº”å•†</button>
            <hr>
            <div id="list-cat" class="tag-box" style="max-height: 250px; overflow-y: auto;"></div>
            <button onclick="addParentCat()" style="font-size:10px; background:var(--primary);">+ æ–°å¢å¤§ç±»</button>
            <hr>
            <button onclick="exportBackup()" style="background:#673ab7; margin-bottom:5px;">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
            <button onclick="importBackup()" style="background:#607d8b; margin-bottom:5px;">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <button onclick="exportExcel()" style="background:#2e7d32;">å¯¼å‡ºExcel</button>
        </div>
    </aside>

    <main>
        <div class="search-bar no-print">
            <div style="flex:1;"><input type="date" id="f-start" onchange="render()"></div>
            <div style="flex:1;"><input type="date" id="f-end" onchange="render()"></div>
            <div style="flex:2;"><input type="text" id="f-key" placeholder="æŸ¥è¯¢..." oninput="render()"></div>
            <button onclick="window.print()" style="width:80px; background:#607d8b;">æ‰“å°</button>
        </div>

        <div id="view-shift">
            <div class="box">
                <b style="color:var(--success);">ğŸ“Š è¥ä¸šç»Ÿè®¡æ±‡æ€»</b>
                <div style="display: flex; gap: 20px; margin-top:10px;">
                    <div style="flex: 1;">
                        <table><thead><tr><th>è¥æ”¶ç±»å‹</th><th>é‡‘é¢</th></tr></thead><tbody id="revTbody"></tbody></table>
                        <b style="color:#e65100; font-size:13px; margin-top:15px; display:block;">ğŸ” è´§å“æ±‡æ€»</b>
                        <table><thead><tr><th>è´§å“</th><th>æ±‡æ€»é¢</th></tr></thead><tbody id="itemTbody"></tbody></table>
                    </div>
                    <div style="flex: 1.5;">
                        <table><thead><tr><th>æ”¯å‡ºæ˜ç»†æ±‡æ€»</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead><tbody id="expTbody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-debt" style="display:none;">
            <div class="box">
                <b>ğŸš› ä¾›åº”å•†å¯¹è´¦æ˜ç»†</b>
                <table><thead><tr><th>ä¾›åº”å•†</th><th>å•æ®å·</th><th>åº”ä»˜</th><th>å·²ä»˜</th><th>å‰©ä½™</th></tr></thead><tbody id="billTbody"></tbody></table>
            </div>
        </div>

        <div id="view-staff" style="display:none;">
            <div class="box">
                <b>ğŸ‘¤ å‘˜å·¥è–ªèµ„ç»Ÿè®¡</b>
                <table><thead><tr><th>å§“å</th><th>åº”å‘</th><th>å€Ÿæ¬¾</th><th>å·®é¢</th></tr></thead><tbody id="staffTbody"></tbody></table>
            </div>
        </div>

        <div class="box">
            <b id="list-title">ğŸ“‘ ä¸šåŠ¡æµæ°´æ˜ç»†</b>
            <table>
                <thead><tr><th style="width:90px">æ—¥æœŸ</th><th style="width:50px">ç±»å‹</th><th>æ˜ç»†</th><th style="width:90px">é‡‘é¢</th><th class="no-print" style="width:40px">å›¾</th><th class="no-print" style="width:40px">åˆ </th></tr></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
    const STORAGE_KEY = "BF_DB_V1299";
    let db = { recs: [], cats: {"è‚‰ç±»":["é¸¡è‚‰","ç‰›è‚‰"],"å¤–å–":["å¤–å–"],"æ‚è´¹":["å…¶ä»–"]}, sups: ['é»˜è®¤ä¾›åº”å•†'], staffs: ['é»˜è®¤å‘˜å·¥'], catOrder: ["è‚‰ç±»","å¤–å–","æ‚è´¹"] };
    const CUR = "C$ ";
    let capturedImgData = null;

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) { try { db = JSON.parse(saved); if(!db.catOrder) db.catOrder = Object.keys(db.cats); } catch(e){} }
        const d = new Date().toISOString().split('T')[0];
        document.getElementById('cal-picker').value = d.substring(0,7);
        document.getElementById('in-date').value = d;
        document.getElementById('debt-date').value = d;
        document.getElementById('staff-date').value = d;
        document.getElementById('f-start').value = d.substring(0,8)+'01';
        document.getElementById('f-end').value = d;
        addExpRow(); render();
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
    }

    // --- æˆªå›¾é€»è¾‘ ---
    async function startCapture(id) {
        document.getElementById('capture-container').style.display = 'block';
        try { const stream = await navigator.mediaDevices.getDisplayMedia({video:true}); document.getElementById('video').srcObject = stream; } 
        catch(e){ alert("æƒé™æ‹’ç»"); closeCapture(); }
    }
    function closeCapture() { 
        const v = document.getElementById('video'); 
        if(v.srcObject) v.srcObject.getTracks().forEach(t => t.stop()); 
        document.getElementById('capture-container').style.display = 'none'; 
    }
    function takeScreenshot() {
        const v = document.getElementById('video');
        const c = document.createElement('canvas');
        c.width = 1280; c.height = (v.videoHeight/v.videoWidth)*1280;
        c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
        capturedImgData = c.toDataURL('image/jpeg', 0.6);
        closeCapture(); alert("æˆªå›¾æˆåŠŸ");
    }

    function switchForm() {
        const m = document.getElementById('main-mode').value;
        const ids = ['shift','debt','staff'];
        ids.forEach(i => {
            document.getElementById(i+'Form').style.display = (m===i?'block':'none');
            document.getElementById('view-'+i).style.display = (m===i?'block':'none');
        });
        render();
    }

    function render() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        const mode = document.getElementById('main-mode').value;
        const fS = document.getElementById('f-start').value, fE = document.getElementById('f-end').value, fK = document.getElementById('f-key').value.toLowerCase();
        
        // é…ç½®æ¸²æŸ“
        document.getElementById('list-sup').innerHTML = db.sups.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('sup',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-sup').innerHTML = db.sups.map(s=>`<option>${s}</option>`).join('');
        document.getElementById('list-staff').innerHTML = db.staffs.map((s,i)=>`<div class="tag">${s}<b onclick="delSet('staff',${i})">Ã—</b></div>`).join('');
        document.getElementById('sel-staff').innerHTML = db.staffs.map(s=>`<option>${s}</option>`).join('');
        
        let catH = "";
        db.catOrder.forEach((p, pi) => {
            catH += `<div style="font-weight:bold; font-size:12px; margin-top:8px; color:#3f51b5; display:flex; justify-content:space-between;">
                <span><span contenteditable="true" onblur="renameParentCat('${p}',this.innerText)">${p}</span> <small onclick="addChildCat('${p}')" style="color:green;cursor:pointer">[+]</small></span>
                <span><span class="move-btn" onclick="moveParent(${pi},-1)">â†‘</span><span class="move-btn" onclick="moveParent(${pi},1)">â†“</span><small onclick="delParentCat('${p}')" style="color:red;cursor:pointer">[Ã—]</small></span>
            </div>`;
            if(db.cats[p]) db.cats[p].forEach((c, ci) => {
                catH += `<div class="tag" style="margin-left:10px;">
                    <span contenteditable="true" onblur="renameChildCat('${p}','${c}',this.innerText)">${c}</span>
                    <span><span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},-1)">â†‘</span><span class="move-btn" style="font-size:10px" onclick="moveChild('${p}',${ci},1)">â†“</span><b onclick="delChildCat('${p}',${ci})">Ã—</b></span>
                </div>`;
            });
        });
        document.getElementById('list-cat').innerHTML = catH;

        // ç»Ÿè®¡é€»è¾‘
        let s = { mCash:0, mPos:0, mExp:0, mSales:0, aSales:0, tDebt:0, mDiff:0 };
        let calData = {}, expAgg = {}, itemAgg = {}, staffSum = {}, billAgg = {};
        db.staffs.forEach(n => staffSum[n] = {sal:0, loan:0});

        db.recs.forEach(r => {
            if(r.type==='buy') s.tDebt += r.amt;
            if(r.type==='pay') s.tDebt -= r.amt;
            if(r.type==='day-sum') s.aSales += r.totalSales;
            
            if(r.date >= fS && r.date <= fE) {
                if(r.type==='day-sum') {
                    s.mCash += r.cash; s.mPos += r.pos; s.mSales += r.totalSales; s.mDiff += r.diff;
                    r.expDetails.forEach(ed => { 
                        s.mExp += ed.amt; expAgg[ed.cat] = (expAgg[ed.cat]||0)+ed.amt;
                        let item = ed.cat.split(':')[1]; itemAgg[item] = (itemAgg[item]||0)+ed.amt;
                    });
                } else if(r.type==='pay') {
                    s.mExp += r.amt; expAgg['è¿˜æ¬¾:ä¾›åº”å•†'] = (expAgg['è¿˜æ¬¾:ä¾›åº”å•†']||0)+r.amt;
                }
                if(r.type==='buy' || r.type==='pay') {
                    let k = r.sup+'_'+(r.bill||'æ— ');
                    if(!billAgg[k]) billAgg[k] = {sup:r.sup, bill:r.bill, buy:0, pay:0};
                    billAgg[k][r.type==='buy'?'buy':'pay'] += r.amt;
                }
                if(staffSum[r.staff]) staffSum[r.staff][r.type==='salary'?'sal':'loan'] += r.amt;
            }
            if(r.type==='day-sum' && r.date.startsWith(document.getElementById('cal-picker').value)) calData[r.date] = (calData[r.date]||0)+r.totalSales;
        });

        // æ›´æ–°çœ‹æ¿
        document.getElementById('h-all-rev').innerText = CUR + s.aSales.toFixed(0);
        document.getElementById('h-mon-rev').innerText = CUR + (s.mCash + s.mPos).toFixed(1);
        document.getElementById('h-pos-info').innerHTML = `ç° ${CUR}${s.mCash.toFixed(1)} | PO ${CUR}${s.mPos.toFixed(1)}`;
        document.getElementById('h-mon-exp').innerText = CUR + s.mExp.toFixed(1);
        document.getElementById('h-profit').innerText = CUR + (s.mSales - s.mExp + s.mDiff).toFixed(1);
        document.getElementById('h-debt').innerText = CUR + s.tDebt.toFixed(1);

        // è¡¨æ ¼æ¸²æŸ“
        document.getElementById('revTbody').innerHTML = `<tr><td>å°ç¥¨æ€»é¢</td><td>${CUR}${s.mSales.toFixed(1)}</td></tr><tr><td>ç°é‡‘å®æ”¶</td><td>${CUR}${s.mCash.toFixed(1)}</td></tr><tr><td>åˆ·å¡(POS)</td><td>${CUR}${s.mPos.toFixed(1)}</td></tr><tr style="color:orange"><td>è¯¯å·®</td><td>${s.mDiff}</td></tr>`;
        document.getElementById('itemTbody').innerHTML = Object.entries(itemAgg).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<tr><td>${k}</td><td>${CUR}${v.toFixed(1)}</td></tr>`).join('');
        
        let eH = "";
        db.catOrder.forEach(p => {
            let pA = 0; Object.entries(expAgg).forEach(([k,v])=>{if(k.startsWith(p+':')) pA+=v;});
            if(pA>0) {
                eH += `<tr style="background:#f9f9f9;font-weight:bold"><td>${p}</td><td>${CUR}${pA.toFixed(1)}</td><td>${(pA/(s.mExp||1)*100).toFixed(1)}%</td></tr>`;
                Object.entries(expAgg).filter(([k])=>k.startsWith(p+':')).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
                    eH += `<tr class="sub-row"><td>â”” ${k.split(':')[1]}</td><td>${CUR}${v.toFixed(1)}</td><td></td></tr>`;
                });
            }
        });
        document.getElementById('expTbody').innerHTML = eH;
        document.getElementById('billTbody').innerHTML = Object.values(billAgg).map(b => `<tr><td>${b.sup}</td><td>${b.bill}</td><td>${b.buy}</td><td>${b.pay}</td><td>${(b.buy-b.pay).toFixed(1)}</td></tr>`).join('');
        document.getElementById('staffTbody').innerHTML = Object.entries(staffSum).map(([n,v])=>`<tr><td>${n}</td><td>${v.sal}</td><td>${v.loan}</td><td>${v.sal-v.loan}</td></tr>`).join('');

        // æµæ°´æ¸²æŸ“
        const filtered = db.recs.filter(r => (r.date>=fS && r.date<=fE) && (!fK || JSON.stringify(r).toLowerCase().includes(fK)));
        document.getElementById('tbody').innerHTML = filtered.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).map(r => `
            <tr>
                <td>${r.date}</td><td>${r.type}</td>
                <td>${r.type==='day-sum'?'è¥æ”¶æ±‡æ€»':(r.sup||r.staff)} ${r.bill||''}</td>
                <td>${CUR}${(r.amt||r.cash+r.pos).toFixed(1)}</td>
                <td class="no-print">${r.img?`<button onclick="showImg('${r.img}')">å›¾</button>`:'-'}</td>
                <td class="no-print"><button onclick="delRec(${r.id})" style="background:#ffcdd2;color:red">åˆ </button></td>
            </tr>`).join('');
        renderCalendar(calData);
    }

    // --- æ ¸å¿ƒè¾…åŠ©å‡½æ•° ---
    function addExpRow() {
        const d = document.createElement('div'); d.className='batch-row';
        let opts = ""; db.catOrder.forEach(p=>db.cats[p].forEach(c=>opts+=`<option value="${p}:${c}">${p}-${c}</option>`));
        d.innerHTML = `<select class="e-cat">${opts}</select><input type="number" class="e-amt" placeholder="é‡‘é¢" oninput="calcShift()"><b onclick="this.parentElement.remove();calcShift()">Ã—</b>`;
        document.getElementById('exp-rows').appendChild(d);
    }
    function calcShift() {
        let t = parseFloat(document.getElementById('in-total-sales').value)||0, p = parseFloat(document.getElementById('in-pos-sales').value)||0, df = parseFloat(document.getElementById('in-diff').value)||0, ex = 0;
        document.querySelectorAll('.e-amt').forEach(i=>ex+=parseFloat(i.value)||0);
        document.getElementById('shift-preview').innerHTML = `æ”¯å‡º:${ex.toFixed(1)} | ç°é‡‘åº”æ”¶:<b>${(t-p-ex+df).toFixed(1)}</b>`;
    }
    function renderCalendar(data) {
        const cal = document.getElementById('calendar'); cal.innerHTML = "";
        const [y, m] = document.getElementById('cal-picker').value.split('-').map(Number);
        const first = new Date(y, m-1, 1).getDay(), last = new Date(y, m, 0).getDate();
        for(let i=0; i<first; i++) cal.innerHTML += '<div></div>';
        for(let d=1; d<=last; d++) {
            let ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`, v = data[ds]||0;
            cal.innerHTML += `<div class="cal-day ${v?'has-data':''}" onclick="setRange('${ds}')"><b>${d}</b><br><small>${v?v.toFixed(0):''}</small></div>`;
        }
    }
    function setRange(d) { document.getElementById('f-start').value=d; document.getElementById('f-end').value=d; render(); }
    function forceSave(r) { db.recs.push(r); render(); alert("ä¿å­˜æˆåŠŸ"); }

    // è¡¨å•æäº¤
    document.getElementById('shiftForm').onsubmit = async (e) => {
        e.preventDefault();
        let exps = []; document.querySelectorAll('#exp-rows .batch-row').forEach(row=>exps.push({cat:row.querySelector('.e-cat').value, amt:parseFloat(row.querySelector('.e-amt').value)||0}));
        let t = parseFloat(document.getElementById('in-total-sales').value), p = parseFloat(document.getElementById('in-pos-sales').value), df = parseFloat(document.getElementById('in-diff').value)||0;
        let es = 0; exps.forEach(x=>es+=x.amt);
        forceSave({id:Date.now(), type:'day-sum', date:document.getElementById('in-date').value, totalSales:t, pos:p, cash:t-p-es+df, diff:df, expDetails:exps, img:capturedImgData});
        e.target.reset(); document.getElementById('exp-rows').innerHTML=""; addExpRow(); capturedImgData=null;
    };
    document.getElementById('debtForm').onsubmit = async (e) => {
        e.preventDefault();
        forceSave({id:Date.now(), type:document.getElementById('in-action').value, date:document.getElementById('debt-date').value, sup:document.getElementById('sel-sup').value, bill:document.getElementById('in-bill').value, amt:parseFloat(document.getElementById('debt-amt').value), img:capturedImgData});
        e.target.reset(); capturedImgData=null;
    };
    document.getElementById('staffForm').onsubmit = async (e) => {
        e.preventDefault();
        forceSave({id:Date.now(), type:document.getElementById('staff-type').value, date:document.getElementById('staff-date').value, staff:document.getElementById('sel-staff').value, amt:parseFloat(document.getElementById('staff-amt').value), notes:document.getElementById('staff-notes').value, img:capturedImgData});
        e.target.reset(); capturedImgData=null;
    };

    // é…ç½®ç®¡ç†
    function addSetting(k) { let v = prompt("è¾“å…¥åç§°:"); if(v) { db[k==='sup'?'sups':'staffs'].push(v); render(); } }
    function delSet(k,i) { db[k==='sup'?'sups':'staffs'].splice(i,1); render(); }
    function addParentCat() { let v = prompt("è¾“å…¥å¤§ç±»:"); if(v) { db.catOrder.push(v); db.cats[v]=[]; render(); } }
    function addChildCat(p) { let v = prompt("è¾“å…¥å°ç±»:"); if(v) { db.cats[p].push(v); render(); } }
    function delRec(id) { if(confirm('åˆ ?')) { db.recs=db.recs.filter(r=>r.id!==id); render(); } }
    function showImg(s) { document.getElementById('modal-content').src=s; document.getElementById('img-modal').style.display='flex'; }
    function renameParentCat(o,n) { if(n && o!==n) { db.cats[n]=db.cats[o]; delete db.cats[o]; db.catOrder[db.catOrder.indexOf(o)]=n; render(); } }
    function renameChildCat(p,o,n) { if(n && o!==n) { db.cats[p][db.cats[p].indexOf(o)]=n; render(); } }
    function moveParent(i,d) { let t=i+d; if(t>=0 && t<db.catOrder.length) { [db.catOrder[i],db.catOrder[t]]=[db.catOrder[t],db.catOrder[i]]; render(); } }
    function moveChild(p,i,d) { let t=i+d; if(t>=0 && t<db.cats[p].length) { [db.cats[p][i],db.cats[p][t]]=[db.cats[p][t],db.cats[p][i]]; render(); } }
    function exportBackup() { let b=new Blob([JSON.stringify(db)],{type:'json'}); let a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='bf_data.json'; a.click(); }
    function exportExcel() { let ws=XLSX.utils.json_to_sheet(db.recs); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"Bluefield.xlsx"); }
    function importBackup() { let i=document.createElement('input'); i.type='file'; i.onchange=e=>{ let f=e.target.files[0]; let r=new FileReader(); r.onload=x=>{ db=JSON.parse(x.target.result); render(); }; r.readAsText(f); }; i.click(); }
</script>
</body>
</html>
