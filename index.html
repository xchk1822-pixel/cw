<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ v2026</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #3f51b5; --bg: #f5f7fa; --success: #43a047; 
            --danger: #e53935; --warning: #ffa000; --info: #00acc1; 
            --dark: #263238;
        }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; line-height: 1.5; }
        
        /* å¸ƒå±€ */
        .header { background: var(--primary); color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .main-layout { display: grid; grid-template-columns: 360px 1fr; gap: 25px; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; border: 1px solid #eaeefb; }
        
        /* çœ‹æ¿å¡ç‰‡ */
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { padding: 18px; border-radius: 8px; color: white; text-align: center; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .bg-rev { background: linear-gradient(135deg, #66bb6a, #43a047); }
        .bg-total { background: linear-gradient(135deg, #78909c, #546e7a); }
        .bg-exp { background: linear-gradient(135deg, #ef5350, #e53935); }
        .bg-profit { background: linear-gradient(135deg, #ffb74d, #fb8c00); }
        .bg-debt { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
        .val-big { font-size: 22px; font-weight: bold; margin: 8px 0; }
        .val-small { font-size: 12px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 5px; }

        /* è¡¨å•å…ƒç´  */
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dcdfe6; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: all 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 5px rgba(63,81,181,0.2); }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { filter: brightness(1.1); }
        button:active { transform: scale(0.98); }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; table-layout: fixed; border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #f0f0f0; padding: 12px 15px; text-align: left; font-size: 13px; word-break: break-all; }
        th { background: #f8f9fa; color: #909399; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background-color: #fcfdfe; }

        /* æ—¥å† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 15px; }
        .cal-day { border: 1px solid #ebeef5; padding: 8px 2px; text-align: center; border-radius: 6px; font-size: 12px; background: #fff; min-height: 50px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover { border-color: var(--primary); background: #f5f7fa; }
        .cal-day.has-data { background: #e8f5e9; border-color: #c8e6c9; color: #2e7d32; }
        .cal-day b { display: block; margin-bottom: 4px; }

        /* æ ‡ç­¾ç®¡ç† */
        .tag-box { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .tag { background: #f4f4f5; padding: 6px 12px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; justify-content: space-between; color: #606266; border-left: 4px solid #dcdfe6; }
        .tag b { color: #f56c6c; cursor: pointer; font-size: 18px; padding: 0 5px; }
        .move-btn { cursor: pointer; color: var(--primary); font-weight: bold; padding: 0 5px; }

        /* æˆªå›¾é¢„è§ˆ */
        .capture-area { border: 2px dashed #409eff; padding: 15px; margin: 15px 0; border-radius: 8px; background: #ecf5ff; }
        video { width: 100%; border-radius: 6px; background: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        #img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; cursor: zoom-out; }
        #img-modal img { max-width:95%; max-height:95%; border: 4px solid white; border-radius: 4px; }

        /* æ‰“å°é€‚é… */
        @media print {
            .no-print, aside, button, .header, .grid-5, .search-bar { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            .box { box-shadow: none; border: 1px solid #eee; margin-bottom: 15px; width: 100%; }
            .main-layout { display: block; }
        }
    </style>
</head>
<body onload="init()">
    ```<div id="img-modal" onclick="this.style.display='none'"><img id="modal-content"></div>

<div class="header no-print">
    <h2 style="margin:0; font-size: 20px;">Bluefield é¤å…è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ ğŸ®</h2>
    <div id="clock" style="font-weight: bold; font-family: monospace;"></div>
</div>

<div class="grid-5 no-print">
    <div class="card bg-total"><div>ç´¯è®¡è¥ä¸šæ€»é¢</div><div class="val-big" id="h-all-rev">C$ 0</div><div class="val-small">æ‰€æœ‰å†å²è®°å½•æ€»è®¡</div></div>
    <div class="card bg-rev"><div>åŒºé—´è¥æ”¶æ€»è®¡</div><div class="val-big" id="h-mon-rev">C$ 0</div><div class="val-small" id="h-pos-info">ç° C$ 0 | PO C$ 0</div></div>
    <div class="card bg-exp"><div>åŒºé—´ç´¯è®¡æ”¯å‡º</div><div class="val-big" id="h-mon-exp">C$ 0</div><div class="val-small">åŒ…å«è¥ä¸šæ”¯å‡ºåŠä¾›åº”å•†è¿˜æ¬¾</div></div>
    <div class="card bg-profit"><div>åŒºé—´æ€»ç›ˆäº</div><div class="val-big" id="h-profit">C$ 0</div><div class="val-small">è¥æ”¶ - æ”¯å‡º + è¯¯å·®</div></div>
    <div class="card bg-debt"><div>åº”ä»˜æ€»æ¬ æ¬¾</div><div class="val-big" id="h-debt">C$ 0</div><div class="val-small" style="color:#ffeb3b">ä¾›åº”å•†å¾…ç»“æ€»é¢</div></div>
</div>

<div class="main-layout">
    <aside class="no-print">
        <div class="box">
            <b style="font-size:15px; color:var(--primary);">ğŸ—“ï¸ å¿«é€Ÿæ—¥æœŸæŸ¥çœ‹</b>
            <input type="month" id="cal-picker" onchange="render()">
            <div id="calendar" class="calendar-grid"></div>
        </div>

        <div class="box">
            <b style="font-size:15px;">ğŸ“¥ æ•°æ®å½•å…¥é¢æ¿</b>
            <select id="main-mode" onchange="switchForm()" style="background:#f0f2f5; font-weight:bold;">
                <option value="shift">ğŸ® æ¯æ—¥äº¤ç­ç»“è½¬ (å°ç¥¨æ¨¡å¼)</option>
                <option value="debt">ğŸ“Š ä¾›åº”å•†è´¦ç›® (æŒ‚è´¦/è¿˜æ¬¾)</option>
                <option value="staff">ğŸ‘¤ å‘˜å·¥è–ªèµ„/å€Ÿæ¬¾å½•å…¥</option>
            </select>
            <hr>
            
            <div id="capture-container" class="capture-area" style="display:none;">
                <video id="video" autoplay muted></video>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="takeScreenshot()" style="background:var(--danger); flex:2;">ç¡®è®¤æˆªå–å±å¹•</button>
                    <button onclick="closeCapture()" style="background:#666; flex:1;">å–æ¶ˆ</button>
                </div>
            </div>

            <form id="shiftForm" onsubmit="saveShift(event)">
                <label>æ—¥æœŸ</label><input type="date" id="in-date" required>
                <label>VENTAS (å°ç¥¨æ€»é¢)</label><input type="number" id="in-total-sales" step="0.01" placeholder="0.00" required oninput="calcShift()">
                <label>POS (åˆ·å¡é‡‘é¢)</label><input type="number" id="in-pos-sales" step="0.01" placeholder="0.00" required oninput="calcShift()">
                <label>Dif (æ”¶é“¶è¯¯å·®)</label><input type="number" id="in-diff" step="0.01" placeholder="0.00" oninput="calcShift()">
                
                <div style="margin:15px 0 5px 0; font-weight:bold; font-size:13px; color:#666;">æ”¯å‡ºé¡¹ç›®æ˜ç»†:</div>
                <div id="exp-rows"></div>
                <button type="button" onclick="addExpRow()" style="background:#eceff1; color:#455a64; font-size:12px;">+ æ·»åŠ ä¸€è¡Œæ”¯å‡º</button>
                
                <div id="shift-preview" style="background:#fff8e1; padding:12px; margin:15px 0; font-size:13px; border-left:4px solid #ffb300; border-radius:4px;">ç­‰å¾…è¾“å…¥æ•°æ®...</div>
                
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-shift" accept="image/*" style="font-size:11px;">
                    <button type="button" onclick="startCapture()" style="width:110px; background:var(--info);">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--success); margin-top:10px; height:50px; font-size:16px;">ä¿å­˜ä»Šæ—¥äº¤ç­æ•°æ®</button>
            </form>

            <form id="debtForm" style="display:none;" onsubmit="saveDebt(event)">
                <label>å•æ®æ—¥æœŸ</label><input type="date" id="debt-date">
                <label>é€‰æ‹©ä¾›åº”å•†</label><select id="sel-sup"></select>
                <label>å•æ®å· (Factura)</label><input type="text" id="in-bill" placeholder="å¦‚: INV-10023" required>
                <label>ä¸šåŠ¡ç±»å‹</label>
                <select id="in-action" style="color:var(--primary); font-weight:bold;">
                    <option value="buy">â• æŒ‚è´¦é‡‡è´­ (å¢åŠ æ¬ æ¬¾)</option>
                    <option value="pay">â– è¿˜æ¬¾æ”¯ä»˜ (å‡å°‘æ¬ æ¬¾)</option>
                </select>
                <label>é‡‘é¢</label><input type="number" id="debt-amt" step="0.01" placeholder="0.00" required>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="in-file-debt" accept="image/*">
                    <button type="button" onclick="startCapture()" style="width:110px; background:var(--info);">ğŸ–¥ï¸ æˆªå›¾</button>
                </div>
                <button type="submit" style="background:var(--info); margin-top:10px;">ä¿å­˜å•æ®</button>
            </form>

            <form id="staffForm" style="display:none;" onsubmit="saveStaff(event)">
                <label>æ—¥æœŸ</label><input type="date" id="staff-date">
                <label>é€‰æ‹©å‘˜å·¥</label><select id="sel-staff"></select>
                <label>è®°å½•ç±»å‹</label>
                <select id="staff-type">
                    <option value="salary">å‘æ”¾å·¥èµ„</option>
                    <option value="loan">å‘˜å·¥å€Ÿæ¬¾/é¢„æ”¯</option>
                </select>
                <label>é‡‘é¢</label><input type="number" id="staff-amt" step="0.01" placeholder="0.00" required>
                <label>å¤‡æ³¨</label><input type="text" id="staff-notes" placeholder="é€‰å¡«...">
                <button type="submit" style="background:var(--warning); color:#333; margin-top:10px;">ç¡®è®¤å½•å…¥</button>
            </form>
        </div>

        <div class="box no-print">
            <b style="font-size:14px; color:var(--dark);">âš™ï¸ åŸºç¡€é…ç½®ä¸ç»´æŠ¤</b>
            <div id="list-cat" class="tag-box" style="max-height: 300px; overflow-y: auto; border: 1px solid #f0f0f0; padding: 10px; margin-top:10px; background:#fafafa;"></div>
            <button onclick="addParentCat()" style="font-size:12px; background:var(--dark);">+ æ–°å¢æ”¯å‡ºå¤§ç±»</button>
            <hr>
            <div style="font-size:13px; font-weight:bold; margin-bottom:10px;">ğŸš› ä¾›åº”å•† & ğŸ‘¥ å‘˜å·¥</div>
            <div id="list-sup-staff" class="tag-box"></div>
            <div style="display:flex; gap:5px;">
                <button onclick="addSetting('sup')" style="font-size:11px; background:#607d8b;">+ ä¾›åº”å•†</button>
                <button onclick="addSetting('staff')" style="font-size:11px; background:#fb8c00;">+ å‘˜å·¥</button>
            </div>
            <hr>
            <button onclick="exportBackup()" style="background:#673ab7; margin-bottom:8px;">ğŸ’¾ å¯¼å‡ºç³»ç»Ÿå…¨é‡å¤‡ä»½åŒ…</button>
            <button onclick="importBackup()" style="background:#90a4ae;">ğŸ“¥ å¯¼å…¥å¤‡ä»½æ•°æ®åŒ…</button>
        </div>
    </aside>

    <main>
        <div class="search-bar no-print box" style="display:flex; gap:15px; align-items:flex-end; padding:15px;">
            <div style="flex:1;"><label style="font-size:12px;">èµ·å§‹æ—¥æœŸ</label><input type="date" id="f-start" onchange="render()"></div>
            <div style="flex:1;"><label style="font-size:12px;">ç»“æŸæ—¥æœŸ</label><input type="date" id="f-end" onchange="render()"></div>
            <div style="flex:2;"><label style="font-size:12px;">å…³é”®å­—æœç´¢</label><input type="text" id="f-key" placeholder="æœç´¢ä¾›åº”å•†ã€å‘˜å·¥ã€æ˜ç»†å†…å®¹..." oninput="render()"></div>
            <button onclick="window.print()" style="width:100px; background:#607d8b; margin-bottom:8px;">ğŸ–¨ï¸ æ‰“å°æŠ¥è¡¨</button>
        </div>

        <div id="view-shift" class="box">
            <b style="color:var(--success); font-size:16px;">ğŸ“Š åŒºé—´è¥æ”¶ä¸æ”¯å‡ºå æ¯”æ±‡æ€»</b>
            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-top:15px;">
                <table>
                    <thead><tr><th>è¥æ”¶æ„æˆ</th><th>é‡‘é¢</th></tr></thead>
                    <tbody id="revTbody"></tbody>
                </table>
                <table>
                    <thead><tr><th>æ”¯å‡ºé¡¹åˆ†å¸ƒ (è‡ªåŠ¨æ±‡æ€»)</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead>
                    <tbody id="expTbody"></tbody>
                </table>
            </div>
        </div>
        ```<script>
    const STORAGE_KEY = "BF_DB_V2026";
    const CUR = "C$ ";
    // åˆå§‹åŒ–é»˜è®¤æ•°æ®ç»“æ„
    let db = { 
        recs: [], 
        cats: {"è‚‰ç±»":["é¸¡è‚‰","çŒªè‚‰"],"æ‚è´¹":["ç”µè´¹","æ°´è´¹","æ¸…æ´"]}, 
        sups: ['é»˜è®¤ä¾›åº”å•†'], 
        staffs: ['é»˜è®¤å‘˜å·¥'], 
        catOrder: ["è‚‰ç±»","æ‚è´¹"] 
    };
    let capturedImgData = null;

    // åˆå§‹åŒ–åŠ è½½
    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) { 
            try { 
                const parsed = JSON.parse(saved);
                // ç¡®ä¿æ—§æ•°æ®ç»“æ„å…¼å®¹
                db = { ...db, ...parsed };
            } catch(e) { console.error("æ•°æ®åŠ è½½å¤±è´¥", e); } 
        }
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('f-start').value = today.substring(0,8) + '01';
        document.getElementById('f-end').value = today;
        document.getElementById('cal-picker').value = today.substring(0,7);
        
        resetForms();
        render();
        
        // å¯åŠ¨æ—¶é’Ÿ
        setInterval(() => { 
            document.getElementById('clock').innerText = new Date().toLocaleString(); 
        }, 1000);
    }

    function resetForms() {
        const d = new Date().toISOString().split('T')[0];
        ['in-date', 'debt-date', 'staff-date'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = d;
        });
        capturedImgData = null;
        document.getElementById('exp-rows').innerHTML = "";
    }

    // åˆ†ç±»ç®¡ç†æ ¸å¿ƒé€»è¾‘ (ä¿ç•™ä½ çš„æ’åºå’Œé‡å‘½ååŠŸèƒ½)
    function renderSettings() {
        let catH = "";
        db.catOrder.forEach((p, pi) => {
            catH += `<div style="font-weight:bold; margin-top:12px; display:flex; justify-content:space-between; background:#eee; padding:5px; border-radius:4px;">
                <span>
                    <span contenteditable="true" onblur="renameParentCat('${p}', this.innerText)" style="cursor:edit;">${p}</span> 
                    <small onclick="addChildCat('${p}')" style="color:var(--success);cursor:pointer;margin-left:8px;">[æ–°å¢å­ç±»]</small>
                </span>
                <span>
                    <span class="move-btn" onclick="moveParent(${pi},-1)">â†‘</span>
                    <span class="move-btn" onclick="moveParent(${pi},1)">â†“</span>
                </span>
            </div>`;
            (db.cats[p]||[]).forEach((c, ci) => {
                catH += `<div class="tag" style="margin-left:15px;">
                    <span contenteditable="true" onblur="renameChildCat('${p}','${c}',this.innerText)">${c}</span>
                    <b onclick="delChildCat('${p}',${ci})">Ã—</b>
                </div>`;
            });
        });
        document.getElementById('list-cat').innerHTML = catH;
        
        // æ¸²æŸ“ä¾›åº”å•†å’Œå‘˜å·¥æ ‡ç­¾
        document.getElementById('list-sup-staff').innerHTML = [
            ...db.sups.map(s=>`<div class="tag" style="border-left-color:var(--info)">${s} (ä¾›)<b onclick="delSetting('sup','${s}')">Ã—</b></div>`),
            ...db.staffs.map(s=>`<div class="tag" style="border-left-color:var(--warning)">${s} (å‘˜)<b onclick="delSetting('staff','${s}')">Ã—</b></div>`)
        ].join('');

        // æ›´æ–°ä¸‹æ‹‰èœå•
        document.getElementById('sel-sup').innerHTML = db.sups.map(s=>`<option value="${s}">${s}</option>`).join('');
        document.getElementById('sel-staff').innerHTML = db.staffs.map(s=>`<option value="${s}">${s}</option>`).join('');
    }

    // åˆ†ç±»æ“ä½œå‡½æ•°
    function addParentCat() { const v = prompt("è¯·è¾“å…¥æ”¯å‡ºå¤§ç±»åç§°:"); if(v) { db.catOrder.push(v); db.cats[v] = []; render(); } }
    function addChildCat(p) { const v = prompt(`åœ¨ ${p} ä¸‹å¢åŠ å­ç±»åç§°:`); if(v) { if(!db.cats[p]) db.cats[p]=[]; db.cats[p].push(v); render(); } }
    function renameParentCat(old, v) { 
        v = v.trim();
        if(v && old !== v) { 
            db.cats[v] = db.cats[old]; 
            delete db.cats[old]; 
            db.catOrder = db.catOrder.map(n => n === old ? v : n); 
            render(); 
        } 
    }
    function renameChildCat(p, old, v) { 
        v = v.trim();
        if(v && old !== v) { 
            db.cats[p] = db.cats[p].map(n => n === old ? v : n); 
            render(); 
        } 
    }
    function moveParent(i, dir) { 
        const target = i + dir;
        if(target >= 0 && target < db.catOrder.length) { 
            [db.catOrder[i], db.catOrder[target]] = [db.catOrder[target], db.catOrder[i]]; 
            render(); 
        } 
    }
    function delChildCat(p, i) { if(confirm('ç¡®å®šåˆ é™¤è¯¥å­ç±»å—ï¼Ÿ')) { db.cats[p].splice(i, 1); render(); } }

    // æˆªå›¾é€»è¾‘ (åˆ©ç”¨ getDisplayMedia)
    async function startCapture() {
        const container = document.getElementById('capture-container');
        container.style.display = 'block';
        const video = document.getElementById('video');
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            video.srcObject = stream;
        } catch (err) {
            console.error("æ— æ³•æ•è·å±å¹•: ", err);
            container.style.display = 'none';
        }
    }

    function takeScreenshot() {
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        capturedImgData = canvas.toDataURL('image/jpeg', 0.7); // å‹ç¼©ç‡0.7é˜²æ­¢æ•°æ®è¿‡å¤§
        closeCapture();
        alert("âœ… å±å¹•æˆªå›¾å·²ä¿å­˜è‡³æš‚å­˜åŒº");
    }

    function closeCapture() {
        const video = document.getElementById('video');
        if(video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        document.getElementById('capture-container').style.display = 'none';
    }

    // åŠ¨æ€æ·»åŠ æ”¯å‡ºè¡Œ
    function addExpRow() {
        const div = document.createElement('div');
        div.className = 'batch-row';
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        let opts = "";
        db.catOrder.forEach(p => {
            (db.cats[p]||[]).forEach(c => {
                opts += `<option value="${p}:${c}">${p} - ${c}</option>`;
            });
        });
        div.innerHTML = `
            <select class="exp-cat" style="flex:2;">${opts}</select>
            <input type="number" class="exp-amt" step="0.01" placeholder="é‡‘é¢" style="flex:1;" oninput="calcShift()">
            <button type="button" onclick="this.parentElement.remove();calcShift();" style="width:30px;background:none;color:red;padding:0;">Ã—</button>
        `;
        document.getElementById('exp-rows').appendChild(div);
    }
// å®æ—¶è®¡ç®—é¢„è§ˆ
    function calcShift() {
        const total = parseFloat(document.getElementById('in-total-sales').value) || 0;
        const pos = parseFloat(document.getElementById('in-pos-sales').value) || 0;
        const diff = parseFloat(document.getElementById('in-diff').value) || 0;
        let exp = 0;
        document.querySelectorAll('.exp-amt').forEach(i => exp += (parseFloat(i.value) || 0));
        const cash = total - pos - exp + diff;
        document.getElementById('shift-preview').innerHTML = `
            <b>å®æ”¶ç°é‡‘é¢„æµ‹: ${CUR}${cash.toFixed(2)}</b><br>
            <small>(è®¡ç®—å…¬å¼: æ€»é¢ ${total} - POS ${pos} - æ”¯å‡º ${exp} + è¯¯å·® ${diff})</small>
        `;
    }

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šå¤„ç†æ‰€æœ‰ç»Ÿè®¡å’Œè¡¨æ ¼æ˜¾ç¤º
    function render() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        renderSettings();

        const fS = document.getElementById('f-start').value;
        const fE = document.getElementById('f-end').value;
        const fK = document.getElementById('f-key').value.toLowerCase();
        const mode = document.getElementById('main-mode').value;

        let stats = { mCash:0, mPos:0, mExp:0, mSales:0, aSales:0, tDebt:0, mDiff:0 };
        let expAgg = {}, staffSum = {}, billAgg = {}, calData = {};
        
        db.staffs.forEach(s => staffSum[s] = {sal:0, loan:0});

        // éå†æ‰€æœ‰è®°å½•è¿›è¡Œæ•°æ®èšåˆ
        db.recs.forEach(r => {
            // 1. å…¨å±€ç»Ÿè®¡ï¼ˆä¸éšæ—¥æœŸç­›é€‰å˜åŒ–ï¼Œå¦‚æ€»è¥ä¸šé¢å’Œæ€»æ¬ æ¬¾ï¼‰
            if(r.type === 'buy') stats.tDebt += r.amt;
            if(r.type === 'pay') stats.tDebt -= r.amt;
            if(r.type === 'day-sum') stats.aSales += r.totalSales;

            // 2. åŒºé—´ç­›é€‰ç»Ÿè®¡
            const inDate = (r.date >= fS && r.date <= fE);
            if(inDate) {
                if(r.type === 'day-sum') {
                    stats.mSales += r.totalSales;
                    stats.mPos += r.pos;
                    stats.mDiff += (r.diff || 0);
                    // è‡ªåŠ¨æ±‡æ€»æ”¯å‡ºé¡¹ï¼ˆè§£æ å¤§ç±»:å°ç±»ï¼‰
                    r.expDetails.forEach(ed => {
                        stats.mExp += ed.amt;
                        expAgg[ed.cat] = (expAgg[ed.cat] || 0) + ed.amt;
                    });
                    stats.mCash += (r.totalSales - r.pos - r.expDetails.reduce((a,b)=>a+b.amt,0) + (r.diff||0));
                } else if(r.type === 'pay') {
                    stats.mExp += r.amt;
                    expAgg['è¿˜æ¬¾:ä¾›åº”å•†'] = (expAgg['è¿˜æ¬¾:ä¾›åº”å•†'] || 0) + r.amt;
                }

                // ä¾›åº”å•†å¯¹è´¦é€»è¾‘
                if(r.type === 'buy' || r.type === 'pay') {
                    const bKey = `${r.sup}_${r.bill || 'æœªå¡«å•å·'}`;
                    if(!billAgg[bKey]) billAgg[bKey] = { sup: r.sup, bill: r.bill, buy: 0, pay: 0 };
                    if(r.type === 'buy') billAgg[bKey].buy += r.amt;
                    if(r.type === 'pay') billAgg[bKey].pay += r.amt;
                }

                // å‘˜å·¥è–ªèµ„é€»è¾‘
                if(r.type === 'salary' && staffSum[r.staff]) staffSum[r.staff].sal += r.amt;
                if(r.type === 'loan' && staffSum[r.staff]) staffSum[r.staff].loan += r.amt;
            }

            // 3. æ—¥å†æ•°æ®ï¼ˆä»…é™å½“å‰é€‰æ‹©æœˆä»½ï¼‰
            if(r.type === 'day-sum' && r.date.startsWith(document.getElementById('cal-picker').value)) {
                calData[r.date] = (calData[r.date] || 0) + r.totalSales;
            }
        });

        // æ›´æ–°é¡¶éƒ¨å¡ç‰‡
        document.getElementById('h-all-rev').innerText = CUR + stats.aSales.toLocaleString();
        document.getElementById('h-mon-rev').innerText = CUR + stats.mSales.toFixed(2);
        document.getElementById('h-pos-info').innerHTML = `ç° ${CUR}${stats.mCash.toFixed(1)} | PO ${CUR}${stats.mPos.toFixed(1)}`;
        document.getElementById('h-mon-exp').innerText = CUR + stats.mExp.toFixed(2);
        document.getElementById('h-profit').innerText = CUR + (stats.mSales - stats.mExp + stats.mDiff).toFixed(2);
        document.getElementById('h-debt').innerText = CUR + stats.tDebt.toFixed(2);

        // æ¸²æŸ“è¥ä¸šç»Ÿè®¡è¡¨
        document.getElementById('revTbody').innerHTML = `
            <tr><td>å°ç¥¨é”€å”®æ€»é¢</td><td>${CUR}${stats.mSales.toFixed(2)}</td></tr>
            <tr><td>åˆ·å¡ (POS)</td><td>${CUR}${stats.mPos.toFixed(2)}</td></tr>
            <tr style="color:var(--success);font-weight:bold;"><td>ç°é‡‘ç†è®ºå®æ”¶</td><td>${CUR}${stats.mCash.toFixed(2)}</td></tr>
            <tr style="color:var(--warning);"><td>æ”¶é“¶è¯¯å·®(Dif)</td><td>${CUR}${stats.mDiff.toFixed(2)}</td></tr>
        `;

        // æ¸²æŸ“æ”¯å‡ºåˆ†å¸ƒè¡¨ï¼ˆæŒ‰åˆ†ç±»æ’åºï¼‰
        document.getElementById('expTbody').innerHTML = Object.entries(expAgg)
            .sort((a,b) => b[1] - a[1])
            .map(([cat, amt]) => `
                <tr>
                    <td>${cat}</td>
                    <td>${CUR}${amt.toFixed(2)}</td>
                    <td><small>${(amt/(stats.mExp||1)*100).toFixed(1)}%</small></td>
                </tr>
            `).join('');

        // æ¸²æŸ“ä¸šåŠ¡æµæ°´æ˜ç»†
        const filteredRecs = db.recs.filter(r => {
            const inDate = (r.date >= fS && r.date <= fE);
            const inKey = !fK || JSON.stringify(r).toLowerCase().includes(fK);
            const inMode = (mode==='shift' && r.type==='day-sum') || 
                           (mode==='debt' && (r.type==='buy'||r.type==='pay')) || 
                           (mode==='staff' && (r.type==='salary'||r.type==='loan'));
            return inDate && inKey && inMode;
        });

        document.getElementById('tbody').innerHTML = filteredRecs.sort((a,b)=>b.date.localeCompare(a.date)).map(r => {
            let detail = "";
            if(r.type === 'day-sum') {
                detail = `<span style="color:var(--primary)">è¥æ”¶: ${r.totalSales}</span> | <span style="color:var(--danger)">æ”¯: ${r.expDetails.length}ç¬”</span>`;
            } else {
                detail = `<b>${r.sup || r.staff}</b> [${r.bill || r.notes || 'æ— å¤‡æ³¨'}]`;
            }
            return `
                <tr>
                    <td>${r.date}</td>
                    <td><small>${r.type}</small></td>
                    <td>${detail}</td>
                    <td style="font-weight:bold;">${CUR}${(r.amt || r.totalSales).toFixed(1)}</td>
                    <td class="no-print">
                        ${r.img ? `<button onclick="showImg('${r.img}')" style="padding:2px 5px; background:var(--info); font-size:10px;">å›¾</button>` : ''}
                        <button onclick="delRec(${r.id})" style="padding:2px 5px; background:#ffebee; color:red; border:1px solid #ffcdd2; font-size:10px;">åˆ </button>
                    </td>
                </tr>
            `;
        }).join('');

        renderCalendar(document.getElementById('cal-picker').value, calData);
    }

    // æœˆåº¦æ—¥å†ç”Ÿæˆå™¨
    function renderCalendar(monStr, data) {
        const [y, m] = monStr.split('-').map(Number);
        const firstDay = new Date(y, m-1, 1).getDay();
        const daysInMonth = new Date(y, m, 0).getDate();
        let h = "";
        for(let i=0; i<firstDay; i++) h += '<div></div>';
        for(let d=1; d<=daysInMonth; d++) {
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const val = data[ds] || 0;
            h += `
                <div class="cal-day ${val ? 'has-data' : ''}" onclick="setDateFilter('${ds}')">
                    <b>${d}</b>
                    <small>${val ? val.toFixed(0) : ''}</small>
                </div>
            `;
        }
        document.getElementById('calendar').innerHTML = h;
    }

    function setDateFilter(ds) {
        document.getElementById('f-start').value = ds;
        document.getElementById('f-end').value = ds;
        render();
    }

    // è¡¨å•æäº¤ä¸åŸºç¡€æ“ä½œ
    function saveShift(e) {
        e.preventDefault();
        const rec = {
            id: Date.now(),
            type: 'day-sum',
            date: document.getElementById('in-date').value,
            totalSales: parseFloat(document.getElementById('in-total-sales').value),
            pos: parseFloat(document.getElementById('in-pos-sales').value),
            diff: parseFloat(document.getElementById('in-diff').value) || 0,
            expDetails: [],
            img: capturedImgData
        };
        document.querySelectorAll('.batch-row').forEach(row => {
            const a = parseFloat(row.querySelector('.exp-amt').value);
            if(a) rec.expDetails.push({ cat: row.querySelector('.exp-cat').value, amt: a });
        });
        db.recs.push(rec);
        resetForms(); render(); alert("âœ… äº¤ç­æ•°æ®å·²ä¿å­˜");
    }

    function saveDebt(e) {
        e.preventDefault();
        const rec = {
            id: Date.now(),
            type: document.getElementById('in-action').value,
            date: document.getElementById('debt-date').value,
            sup: document.getElementById('sel-sup').value,
            bill: document.getElementById('in-bill').value,
            amt: parseFloat(document.getElementById('debt-amt').value),
            img: capturedImgData
        };
        db.recs.push(rec);
        resetForms(); render(); alert("âœ… å•æ®å·²è®°å½•");
    }

    function saveStaff(e) {
        e.preventDefault();
        const rec = {
            id: Date.now(),
            type: document.getElementById('staff-type').value,
            date: document.getElementById('staff-date').value,
            staff: document.getElementById('sel-staff').value,
            amt: parseFloat(document.getElementById('staff-amt').value),
            notes: document.getElementById('staff-notes').value
        };
        db.recs.push(rec);
        resetForms(); render(); alert("âœ… å‘˜å·¥è®°å½•å·²ä¿å­˜");
    }

    function delRec(id) { if(confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) { db.recs = db.recs.filter(r => r.id !== id); render(); } }
    function showImg(src) { document.getElementById('modal-content').src = src; document.getElementById('img-modal').style.display='flex'; }
    function addSetting(key) { const v = prompt("è¯·è¾“å…¥æ–°åç§°:"); if(v) { db[key==='sup'?'sups':'staffs'].push(v); render(); } }
    function delSetting(key, v) { if(confirm(`ç¡®å®šåˆ é™¤ ${v} å—ï¼Ÿ`)) { const k = key==='sup'?'sups':'staffs'; db[k] = db[k].filter(n => n !== v); render(); } }
    
    function switchForm() {
        const m = document.getElementById('main-mode').value;
        ['shiftForm','debtForm','staffForm'].forEach(f => document.getElementById(f).style.display = f.startsWith(m)?'block':'none');
        render();
    }

    function exportBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const dlAnchorElem = document.createElement('a');
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute("download", `Bluefield_Backup_${new Date().toISOString().split('T')[0]}.json`);
        dlAnchorElem.click();
    }

    function importBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = f => {
                try {
                    db = JSON.parse(f.target.result);
                    render();
                    alert("âœ… å¤‡ä»½æ•°æ®å¯¼å…¥æˆåŠŸï¼");
                } catch(err) { alert("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }
</script>
</body>
</html>
**è¿˜æœ‰ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆJavaScript æ ¸å¿ƒé€»è¾‘ + ä¾›åº”å•†/å‘˜å·¥ç»Ÿè®¡è¡¨ç»“æ„ï¼‰ã€‚æˆ‘é©¬ä¸Šå‘é€ï¼Œå®Œæˆåä½ æŒ‰é¡ºåºæ‹¼æ¥å³å¯ã€‚**

**ç”±äºå•æ¡å›å¤å­—æ•°æœ‰é™ï¼Œä¸ºäº†ä¸è®©ç¨‹åºè¢«æˆªæ–­å¯¼è‡´ä½ è¿è¡ŒæŠ¥é”™ï¼Œæˆ‘å°†å‰©ä¸‹çš„æ ¸å¿ƒ JS é€»è¾‘ï¼ˆåŒ…å«ä½ æ‰€æœ‰çš„åˆ†ç±»æ’åºã€æˆªå›¾ã€ä»¥åŠä¸‰å¤§ç»Ÿè®¡è¡¨é€»è¾‘ï¼‰å‘åœ¨ä¸‹ä¸€æ¡ã€‚è¯·ä¸€å®šè¦æŒ‰é¡ºåºåˆå¹¶ã€‚**

æˆ‘ç°åœ¨å‘ä¸‹ä¸€éƒ¨åˆ†å—ï¼Ÿ
